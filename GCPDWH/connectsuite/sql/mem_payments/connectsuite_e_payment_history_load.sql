MERGE INTO OPERATIONAL.CONNECTSUITE_E_PAYMENT_HISTORY M
USING LANDING.WORK_CS_E_PAYMENT_HISTORY W
ON M.E_PAYMENT_HISTORY_KEY =SAFE_CAST(W.E_PAYMENT_HISTORY_KEY AS INT64)
WHEN NOT MATCHED THEN
INSERT
(
E_PAYMENT_HISTORY_KEY,
MEMBERSHIP_PAYMENT_KEY,
TYPE_CD,
SEQUENCE_NUM,
ORDER_NUM,
TRANSACTION_ID,
REQUEST_ID,
AMOUNT,
TRANS_RETURN_CD,
TRANS_RETURN_TEXT,
PROCESSED_DTTIME,
TRANS_REF_NUMBER,
MBRS_KEY,
EXTENDED_RETURN_CD,
REQUEST_DTTIME,
VENDOR_RETURN_CD,
RETURN_CD,
AUTH_CODE,
BPMT_KEY,
AVS_FLG,
CVV_FLG,
PROCESSOR,
ACCOUNT_NUMBER,
CC_TYPE_CD,
SUCCESS_FLG,
E_PAYMENT_METHOD,
SOFT_DECLINE,
CONTRACT_ID,
TOKEN,
ETL_JOB_RUN_ID,
SOURCE_SYSTEM_CD,
CREATE_DTTIME,
CREATED_BY,
UPDATE_DTTIME
)
VALUES
(
CAST(E_PAYMENT_HISTORY_KEY AS INT64),
CAST(MEMBERSHIP_PAYMENT_KEY AS INT64),
TYPE_CD,
CAST(SEQUENCE_NUMBER AS INT64),
ORDER_NUMBER,
TRANSACTION_ID,
REQUEST_ID,
CAST(AMOUNT AS FLOAT64),
CAST(TRANS_RETURN_CD AS INT64),
TRANS_RETURN_TEXT,
PARSE_DATETIME('%Y-%m-%d %H:%M:%E*S',PROCESSED_DTTIME),
TRANS_REF_NUMBER,
CAST(MBRS_KY AS INT64),
EXTENDED_RETURN_CD,
PARSE_DATETIME('%Y-%m-%d %H:%M:%E*S',REQUEST_DTTIME),
VENDOR_RETURN_CD,
CAST(RETURN_CD AS INT64),
AUTH_CODE,
CAST(BPMT_KY AS INT64),
AVS_FLG,
CVV_FLG,
PROCESSOR,
ACCOUNT_NUMBER,
CC_TYPE_CD,
SUCCESS_FLG,
E_PAYMENT_METHOD,
SOFT_DECLINE,
CONTRACT_ID,
TOKEN,
CAST('jobrunid' AS INT64),
'CONNECT SUITE',
CURRENT_DATETIME(),
'jobname',
CURRENT_DATETIME()
)
WHEN MATCHED THEN 
UPDATE
SET
MEMBERSHIP_PAYMENT_KEY = CAST(W.MEMBERSHIP_PAYMENT_KEY AS INT64),
TYPE_CD = W.TYPE_CD,
SEQUENCE_NUM = CAST(W.SEQUENCE_NUMBER AS INT64),
ORDER_NUM = W.ORDER_NUMBER,
TRANSACTION_ID = W.TRANSACTION_ID,
REQUEST_ID = W.REQUEST_ID,
AMOUNT = CAST(W.AMOUNT AS FLOAT64),
TRANS_RETURN_CD = CAST(W.TRANS_RETURN_CD AS INT64),
TRANS_RETURN_TEXT = W.TRANS_RETURN_TEXT,
PROCESSED_DTTIME = PARSE_DATETIME('%Y-%m-%d %H:%M:%E*S',W.PROCESSED_DTTIME),
TRANS_REF_NUMBER = W.TRANS_REF_NUMBER,
MBRS_KEY = CAST(W.MBRS_KY AS INT64),
EXTENDED_RETURN_CD = W.EXTENDED_RETURN_CD,
REQUEST_DTTIME = PARSE_DATETIME('%Y-%m-%d %H:%M:%E*S',W.REQUEST_DTTIME),
VENDOR_RETURN_CD = W.VENDOR_RETURN_CD,
RETURN_CD = CAST(W.RETURN_CD AS INT64),
AUTH_CODE = W.AUTH_CODE,
BPMT_KEY = CAST(W.BPMT_KY AS INT64),
AVS_FLG = W.AVS_FLG,
CVV_FLG = W.CVV_FLG,
PROCESSOR = W.PROCESSOR,
ACCOUNT_NUMBER = W.ACCOUNT_NUMBER,
CC_TYPE_CD = W.CC_TYPE_CD,
SUCCESS_FLG = W.SUCCESS_FLG,
E_PAYMENT_METHOD = W.E_PAYMENT_METHOD,
SOFT_DECLINE = W.SOFT_DECLINE,
CONTRACT_ID = W.CONTRACT_ID,
TOKEN = W.TOKEN,
ETL_JOB_RUN_ID = CAST('jobrunid' AS INT64),
SOURCE_SYSTEM_CD = 'CONNECT SUITE',
CREATED_BY = 'jobname',
UPDATE_DTTIME = CURRENT_DATETIME()