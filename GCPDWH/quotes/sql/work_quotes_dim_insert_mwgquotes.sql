INSERT INTO `LANDING.WORK_QUOTES_DIM` (
QUOTE_NUM,
POLICY_NUM,
CREATE_DT ,
UPDATE_DT,
EFFECTIVE_DT,
QUOTE_ID,
OPPORTUNITY_ID,
CUSTOMER_ID,
SOURCE_CUSTOMER_ID,
POLICY_STATUS,
PRODUCT_TYPE,
PRODUCT_CD,
POLICY_STATE,
PREMIUM,
POLICY_TERM_MONTHS,
POLICY_CARRIER,
SOURCE_SYSTEM,
CURRENT_IMAGE_IND,
AGE_OF_QUOTE,
QUOTE_VERSION_AGE,
QUOTE_COUNT,
UPLOAD_COUNT,
QUOTE_STATUS,
TRANSACTION_TYPE,
BINDING_AGENT,
AGENT_OF_RECORD,
PRODUCER_EMAIL,
EMPLOYEE_ID,
CHANNEL_TYPE,
AGENCY_NM,
SALES_CHANNEL,
AGENCY_LOCATION_NM,
AGENCY_LOCATION_ID,
LEAD_SOURCE,
QUOTE_TYPE,
CONVERSION_DT,
IMPORTED_FLAG,
PRIOR_POLICY_NUM,
PRIOR_INSURANCE_COMPANY,
PRIOR_CARRIER_BI_LIMIT,
DAYS_LAPSED,
HOME_OWNER_TYPE,
ASSOCIATION,
MEMBERSHIP_NUM,
TIER,
AGENT_NOTE,
UW_NOTE,
LICENSE_STATUS_INFORMATION,
CLUE_INFORMATION,
VEHICLE_USAGE,
OTHER_NOTES,
FR_LEVEL,
GENDER,
TOLL_FREE_NUM,
INSERT_DT,
INSERT_BY,
LAST_UPDATED_AGENT,
LAST_UPDATED_DT,
VOICE_BIND,
PACKAGE_TYPE,
TXN_TYPE_IND,
MDM_CUSTOMER_KEY,
JOB_RUN_ID,
SOURCE_SYSTEM_CD,
CREATED_DT,
CREATE_BY,
SELLING_LOCATION_ID,
REVENUE_LOCATION_ID,
COMPENSATION_EMPLOYEE_ID,
PROCESSED_EMPLOYEE_ID,
MD5_VALUE,
EFF_START_DT)
SELECT 
QUOTE_NUM,
POLICY_NUM,
CREATE_DT,
UPDATE_DT,
EFFECTIVE_DT,
QUOTE_ID,
OPPORTUNITY_ID,
CUSTOMER_ID,
SOURCE_CUSTOMER_ID,
POLICY_STATUS,
PRODUCT_TYPE,
PRODUCT_CD,
POLICY_STATE,
PREMIUM,
POLICY_TERM_MONTHS,
POLICY_CARRIER,
SOURCE_SYSTEM,
CURRENT_IMAGE_IND,
AGE_OF_QUOTE,
QUOTE_VERSION_AGE,
QUOTE_COUNT,
UPLOAD_COUNT,
QUOTE_STATUS,
TRANSACTION_TYPE,
BINDING_AGENT,
AGENT_OF_RECORD,
PRODUCER_EMAIL,
EMPLOYEE_ID,
CHANNEL_TYPE,
AGENCY_NM,
SALES_CHANNEL,
AGENCY_LOCATION_NM,
AGENCY_LOCATION_ID,
LEAD_SOURCE,
QUOTE_TYPE,
CONVERSION_DT,
IMPORTED_FLAG,
PRIOR_POLICY_NUM,
PRIOR_INSURANCE_COMPANY,
PRIOR_CARRIER_BI_LIMIT,
DAYS_LAPSED,
HOME_OWNER_TYPE,
ASSOCIATION,
MEMBERSHIP_NUM,
TIER,
AGENT_NOTE,
UW_NOTE,
LICENSE_STATUS_INFORMATION,
CLUE_INFORMATION,
VEHICLE_USAGE,
OTHER_NOTES,
FR_LEVEL,
GENDER,
TOLL_FREE_NUM,
INSERT_DT,
INSERT_BY,
LAST_UPDATED_AGENT,
LAST_UPDATED_DT,
VOICE_BIND,
PACKAGE_TYPE,
TXN_TYPE_IND,
MDM_CUSTOMER_KEY,
ETL_JOB_RUN_ID,
SOURCE_SYSTEM_CD,
CREATE_DTTIME,
CREATE_BY,
safe_cast(SELLING_LOCATION_ID as INT64),
safe_cast(REVENUE_LOCATION_ID as INT64),
COMPENSATION_EMPLOYEE_ID,
SAFE_CAST(PROCESSED_EMPLOYEE_ID as STRING),
md5(CONCAT
(COALESCE(QUOTE_NUM,''),
COALESCE(POLICY_NUM,''),
COALESCE(SAFE_CAST(CREATE_DT AS STRING),''),
COALESCE(SAFE_CAST( EFFECTIVE_DT as STRING),''),
COALESCE(SAFE_CAST(QUOTE_ID as STRING),''),
COALESCE(SAFE_CAST( OPPORTUNITY_ID as STRING),''),
COALESCE(SAFE_CAST( CUSTOMER_ID as STRING),''), 
COALESCE(SOURCE_CUSTOMER_ID,''), 
COALESCE(POLICY_STATUS,''), 
COALESCE(PRODUCT_TYPE,''), 
COALESCE(PRODUCT_CD,''), 
COALESCE(POLICY_STATE,''),
COALESCE(SAFE_CAST( PREMIUM as STRING),''),
COALESCE(SAFE_CAST( POLICY_TERM_MONTHS as STRING),''),
COALESCE(POLICY_CARRIER,''), 
COALESCE(SOURCE_SYSTEM,''),
COALESCE(SAFE_CAST(CURRENT_IMAGE_IND as STRING),''), 
COALESCE(AGE_OF_QUOTE,''), 
COALESCE(QUOTE_VERSION_AGE,''),
COALESCE(SAFE_CAST( QUOTE_COUNT as STRING),''),
COALESCE(SAFE_CAST( UPLOAD_COUNT as STRING),''), 
COALESCE(QUOTE_STATUS,''), 
COALESCE(TRANSACTION_TYPE,''), 
COALESCE(BINDING_AGENT,''), 
COALESCE(AGENT_OF_RECORD,''), 
COALESCE(PRODUCER_EMAIL,''), 
COALESCE(SAFE_CAST(EMPLOYEE_ID as STRING),''), 
COALESCE(CHANNEL_TYPE,''), 
COALESCE(AGENCY_NM,''), 
COALESCE(SALES_CHANNEL,''), 
COALESCE(AGENCY_LOCATION_NM,''),
COALESCE(SAFE_CAST( AGENCY_LOCATION_ID as STRING),''), 
COALESCE(LEAD_SOURCE,''), 
COALESCE(QUOTE_TYPE,''),
COALESCE(SAFE_CAST( CONVERSION_DT as STRING),''), 
COALESCE(IMPORTED_FLAG,''), 
COALESCE(PRIOR_POLICY_NUM,''), 
COALESCE(PRIOR_INSURANCE_COMPANY,''), 
COALESCE(PRIOR_CARRIER_BI_LIMIT,''),
COALESCE(SAFE_CAST( DAYS_LAPSED as STRING),''), 
COALESCE(HOME_OWNER_TYPE,''), 
COALESCE(ASSOCIATION,''), 
COALESCE(MEMBERSHIP_NUM,''), 
COALESCE(TIER,''), 
COALESCE(AGENT_NOTE,''), 
COALESCE(UW_NOTE,''), 
COALESCE(LICENSE_STATUS_INFORMATION,''), 
COALESCE(CLUE_INFORMATION,''), 
COALESCE(VEHICLE_USAGE,''), 
COALESCE(OTHER_NOTES,''), 
COALESCE(FR_LEVEL,''), 
COALESCE(GENDER,''), 
COALESCE(TOLL_FREE_NUM,''), 
COALESCE(VOICE_BIND,''), 
COALESCE(PACKAGE_TYPE,''), 
COALESCE(SAFE_CAST(TXN_TYPE_IND as STRING),''), 
COALESCE(SAFE_CAST(MDM_CUSTOMER_KEY as STRING),''), 
COALESCE(SAFE_CAST(SELLING_LOCATION_ID as STRING),''), 
COALESCE(SAFE_CAST(REVENUE_LOCATION_ID as STRING),''), 
COALESCE(SAFE_CAST(COMPENSATION_EMPLOYEE_ID as STRING),''), 
COALESCE(SAFE_CAST(PROCESSED_EMPLOYEE_ID as STRING),'')
))AS HashValue,
EFF_START_DT

FROM
(SELECT 
PAS.QUOTE_NUM AS  QUOTE_NUM,
PAS.POLICY_NUM AS  POLICY_NUM,
PARSE_DATE("%m/%d/%Y",PAS.CREATE_DT) AS CREATE_DT,
PARSE_DATE("%m/%d/%Y",PAS.UPDATE_DT) AS UPDATE_DT,
PARSE_DATE("%m/%d/%Y",PAS.EFFECTIVE_DT)  AS  EFFECTIVE_DT,
SAM.QUOTE_ID AS  QUOTE_ID,
SAM.OPPORTUNITY_ID AS  OPPORTUNITY_ID,
SAM.CUSTOMER_ID AS  CUSTOMER_ID,
SAM.SOURCE_CUSTOMER_ID AS  SOURCE_CUSTOMER_ID,
SAM.POLICY_STATUS AS  POLICY_STATUS,
SAM.PRODUCT_TYPE AS  PRODUCT_TYPE,
SAM.PRODUCT_CD AS  PRODUCT_CD,
SAM.POLICY_STATE AS  POLICY_STATE,
SAFE_CAST(SAM.PREMIUM AS INT64) AS PREMIUM,
SAM.POLICY_TERM_MONTHS AS  POLICY_TERM_MONTHS,
SAM.POLICY_CARRIER AS  POLICY_CARRIER,
SAM.SOURCE_SYSTEM AS  SOURCE_SYSTEM,
PAS.CURRENT_IMAGE_IND AS  CURRENT_IMAGE_IND,
PAS.AGE_OF_QUOTE AS  AGE_OF_QUOTE,
PAS.QUOTE_VERSION_AGE AS  QUOTE_VERSION_AGE,
PAS.QUOTE_COUNT AS  QUOTE_COUNT,
PAS.UPLOAD_COUNT AS  UPLOAD_COUNT,
PAS.QUOTE_STATUS AS  QUOTE_STATUS,
PAS.TRANSACTION_TYPE AS  TRANSACTION_TYPE,
PAS.BINDING_AGENT AS  BINDING_AGENT,
PAS.AGENT_OF_RECORD AS  AGENT_OF_RECORD,
PAS.PRODUCER_EMAIL AS  PRODUCER_EMAIL,
SAFE_CAST(COALESCE(WS.EMPLOYEE_ID,W.EMPLOYEE_ID) AS STRING)  AS EMPLOYEE_ID ,
PAS.CHANNEL_TYPE AS  CHANNEL_TYPE,
PAS.AGENCY_NM AS  AGENCY_NM,
PAS.SALES_CHANNEL AS  SALES_CHANNEL,
PAS.AGENCY_LOCATION_NM AS  AGENCY_LOCATION_NM,
PAS.AGENCY_LOCATION_ID AS  AGENCY_LOCATION_ID,
PAS.LEAD_SOURCE AS  LEAD_SOURCE,
PAS.QUOTE_TYPE AS  QUOTE_TYPE,
PARSE_DATE("%m/%d/%Y",PAS.CONVERSION_DT) AS CONVERSION_DT,
PAS.IMPORTED_FLAG AS  IMPORTED_FLAG,
PAS.PRIOR_POLICY_NUM AS  PRIOR_POLICY_NUM,
PAS.PRIOR_INSURANCE_COMPANY AS  PRIOR_INSURANCE_COMPANY,
PAS.PRIOR_CARRIER_BI_LIMIT AS  PRIOR_CARRIER_BI_LIMIT,
PAS.DAYS_LAPSED AS  DAYS_LAPSED,
PAS.HOME_OWNER_TYPE AS  HOME_OWNER_TYPE,
PAS.ASSOCIATION AS  ASSOCIATION,
MWG.MEMBER_NUM AS  MEMBERSHIP_NUM, -- Modified on 5/23
PAS.TIER AS  TIER,
PAS.AGENT_NOTE AS  AGENT_NOTE,
PAS.UW_NOTE AS  UW_NOTE,
PAS.LICENSE_STATUS_INFORMATION AS  LICENSE_STATUS_INFORMATION,
PAS.CLUE_INFORMATION AS  CLUE_INFORMATION,
PAS.VEHICLE_USAGE AS  VEHICLE_USAGE,
PAS.OTHER_NOTES AS  OTHER_NOTES,
PAS.FR_LEVEL AS  FR_LEVEL,
PAS.GENDER AS  GENDER,
PAS.TOLL_FREE_NUM AS  TOLL_FREE_NUM,
PARSE_DATE("%m/%d/%Y",PAS.INSERT_DT)AS INSERT_DT,
UPPER(PAS.INSERT_BY) AS  INSERT_BY,
PAS.LAST_UPDATED_AGENT AS  LAST_UPDATED_AGENT,
PARSE_DATE("%m/%d/%Y",PAS.UPDATE_DT)  AS  LAST_UPDATED_DT,
PAS.VOICE_BIND AS  VOICE_BIND,
PAS.PACKAGE_TYPE AS  PACKAGE_TYPE,
CASE WHEN PAS.POLICY_NUM IS NULL and PAS.QUOTE_NUM IS NOT NULL
THEN 
'QUOTE'
WHEN
PAS.POLICY_NUM IS NOT NULL and PAS.QUOTE_NUM IS NOT NULL and DATE_DIFF(current_date(),PARSE_DATE("%m/%d/%Y",PAS.EFFECTIVE_DT),DAY) >1
THEN
'NEW'
ELSE
''
END TXN_TYPE_IND,
CB.CUSTOMER_MDM_KEY AS MDM_CUSTOMER_KEY,
SAFE_CAST('v_job_run_id' AS INT64) AS ETL_JOB_RUN_ID,
CONCAT("PAS",SAM.SOURCE_SYSTEM) AS SOURCE_SYSTEM_CD,
current_date() as CREATE_DTTIME,
'load-quotes-dim' AS CREATE_BY,
BZ.LOCATION_ID AS SELLING_LOCATION_ID,
BZ.ZIP_CD  AS REVENUE_LOCATION_ID,
SAFE_CAST(COALESCE(WS.EMPLOYEE_ID,W.EMPLOYEE_ID) AS INT64)  AS COMPENSATION_EMPLOYEE_ID,
SAFE_CAST(COALESCE(WS.EMPLOYEE_ID,W.EMPLOYEE_ID) AS INT64)   AS PROCESSED_EMPLOYEE_ID,
PARSE_DATE("%Y%m%d",'V_FILE_ID') AS EFF_START_DT,
ROW_NUMBER() OVER (PARTITION BY PAS.QUOTE_NUM ORDER BY PAS.UPDATE_DT,PAS.AGE_OF_QUOTE DESC) AS DUP_CHECK
FROM  LANDING.WORK_PAS_QUOTES PAS 
LEFT OUTER JOIN LANDING.SAM_QUOTES_LDG SAM
ON 
(CASE WHEN SUBSTR(SAM.POLICY_NUM,1,1)='Q' THEN SUBSTR(SAM.POLICY_NUM,6) ELSE  SUBSTR(SAM.POLICY_NUM,5) END) = SUBSTR(PAS.QUOTE_NUM ,6)
LEFT OUTER JOIN OPERATIONAL.MWG_STG_INSURANCE_QUOTE MWG ON PAS.QUOTE_NUM = MWG.QUOTE_NUM -- Modified on 5/23
LEFT JOIN CUSTOMERS.EMPLOYEE_PROFILE_DIM W
ON  W.EMAIL_ADDRESS=PAS.PRODUCER_EMAIL AND W.ACTIVE_FLG='Y'
LEFT JOIN CUSTOMERS.EMPLOYEE_PROFILE_DIM WS
ON  WS.SECONDARY_EMAIL_ADDRESS=PAS.PRODUCER_EMAIL AND WS.ACTIVE_FLG='Y'
LEFT OUTER JOIN `CUSTOMER_PRODUCT.LOCATION_ZIP_DIM`  BZ
ON BZ.LOCATION_ID = W.LOCATION_ID
LEFT OUTER JOIN `CUSTOMER_PRODUCT.MDM_CUSTOMER_BRIDGE` CB
ON CB.SOURCE_KEY1 = CAST(SAM.CUSTOMER_ID AS STRING) AND CB.SOURCE_SYSTEM_CD = 'SAM' )
WHERE DUP_CHECK=1
