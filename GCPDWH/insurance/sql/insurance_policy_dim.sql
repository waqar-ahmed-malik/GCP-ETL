-- DELETE FROM CUSTOMER_PRODUCT.INSURANCE_DIM WHERE TRUE

INSERT INTO CUSTOMER_PRODUCT.INSURANCE_POLICY_DIM (
INSURANCE_DIM_KEY,
SOURCE_ID,
DATA_SOURCE,
SOURCE_PRODUCT_CD,
PRODUCT_CD,
PRODUCT_TYPE,
SUB_PRODUCT_TYPE ,
POLICY_STATE ,
POLICY_PREFIX	,
POLICY_NUM	,
AGREEMENT_NUM 	,
IG_MDM_AGREEMENT_NUM ,
STATUS_CD  	,
POLICY_INFORCE_IND	,
INCEPTION_DT	,
TERM_EFFECTIVE_DT	,
TERM_EXPIRATION_DT	,
CANCEL_DT ,
CANCEL_REASON_CD ,
CANCEL_REASON_DESC ,
PREVIOUS_INSURANCE_COMPANY_NM,
PRIOR_POLICY_NUM,
CONVERSION_FLG 	,
PAYMENT_PLAN_CD		,
PAYMENT_PLAN_DESC,
LAST_ENDORSEMENT_DT,
GROUP_CD,
GROUP_CD_DESC,
AVG_ANNUAL_MILEAGE,
INSURANCE_COMPANY,
VIOLATION_DT,
VIOLATION_PTS,
ROW_START_DT,
ROW_END_DT,
ACTIVE_FLG			,
MD5_VALUE		,
JOB_RUN_ID	,
SOURCE_SYSTEM_CD	,
UPDATE_DTTIME	

)
SELECT DISTINCT * EXCEPT(DUP_CHECK) FROM (
SELECT 
STG.INSURANCE_DIM_KEY,
STG.SOURCE_ID,
STG.DATA_SOURCE,
STG.SOURCE_PRODUCT_CD,
STG.PRODUCT_CD,
STG.PRODUCT_TYPE,
STG.SUB_PRODUCT_TYPE ,
STG.POLICY_STATE ,
STG.POLICY_PREFIX	,
STG.POLICY_NUM	,
STG.AGREEMENT_NUM 	,
STG.IG_MDM_AGREEMENT_NUM ,
STG.STATUS_CD  	,
STG.POLICY_INFORCE_IND	,
STG.INCEPTION_DT	,
STG.TERM_EFFECTIVE_DT	,
STG.TERM_EXPIRATION_DT	,
STG.CANCEL_DT 	,
STG.CANCEL_REASON_CD ,
STG.CANCEL_REASON_DESC ,
STG.PREVIOUS_INSURANCE_COMPANY_NM,
STG.PRIOR_POLICY_NUM,
STG.CONVERSION_FLG 	,
STG.PAYMENT_PLAN_CD		,
STG.PAYMENT_PLAN_DESC,
STG.LAST_ENDORSEMENT_DT,
STG.GROUP_CD		,
STG.GROUP_CD_DESC,
STG.AVG_ANNUAL_MILEAGE,
STG.INSURANCE_COMPANY,
STG.VIOLATION_DT,
STG.VIOLATION_PTS,
CURRENT_DATE(),
DATE('9999-12-31'),
'Y'	,
STG.MD5_VALUE,
'V_JOB_RUN_ID',
"insurance",
STG.UPDATE_DTTIME,
ROW_NUMBER() OVER (PARTITION BY INSURANCE_DIM_KEY  ORDER BY UPDATE_DTTIME DESC ) DUP_CHECK
FROM LANDING.WORK_INSURANCE_POLICY_DIM STG
WHERE (( STG.INSURANCE_DIM_KEY NOT IN ( SELECT INSURANCE_DIM_KEY FROM `CUSTOMER_PRODUCT.INSURANCE_POLICY_DIM` WHERE ACTIVE_FLG='Y') )  --For New Policies
OR (STG.INSURANCE_DIM_KEY IN ( SELECT INSURANCE_DIM_KEY FROM  `CUSTOMER_PRODUCT.INSURANCE_POLICY_DIM`  DIM  WHERE DIM.ACTIVE_FLG='Y') AND STG.MD5_VALUE NOT IN (SELECT DIM.MD5_VALUE  FROM  `CUSTOMER_PRODUCT.INSURANCE_POLICY_DIM`  DIM  )) )) WHERE DUP_CHECK = 1-- For Tye 2 History Based on MD5 Value Change for Existing Policies
