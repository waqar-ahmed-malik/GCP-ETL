INSERT INTO CUSTOMER_PRODUCT.COR_TRANSACTION_FACT(
INVOICE_KEY,
CUSTOMER_MDM_KEY,
LOCATION_ID,
INVOICE_ID,
INVOICE_CREATE_DTTIME,
INVOICE_DELETE_DTTIME,
INVOICE_DELETION_TIME_SPECIFIED,
INVOICE_LAST_MODIFIED_DTTIME,
INVOICE_LAST_MODIFIED_BY,
INVOICE_TYPE,
INVOICE_SCHEDULED_DTTIME,
INVOICE_PROMISED_DTTIME,
INVOICE_DTTIME,
WORK_ORDER_NUM,
INVOICE_NUM,
PURCHASE_ORDER_NUM,
CONTACT_ID,
MARKETING_SOURCE,
SERVICE_ITEM_IS_COMPLETE,
SERVICE_ADVISOR_ID,
SERVICE_ADVISOR_TYPE,
SERVICE_ADVISOR_NM,
TECHNICIAN_ID,
TECHNICIAN_TYPE,
TECHNICIAN_NM,
INVOICE_DURATION,
INVOICE_IN_USAGE,
INVOICE_OUT_USAGE,
INVOICE_WORKFLOW_STAGE,
INVOICE_SEARCH_STRING,
INVOICE_NOTE,
PARTS_TOTAL,
LABOR_TOTAL,
SUBLET_TOTAL,
NET_TOTAL,
OTHER_CHARGE_TOTAL,
GRAND_TOTAL,
OTHER_CHARGE_CD,
INVOICE_FLAG,
INVOICE_TAGS,
INVOICE_COMPLETED,
SURVEY_SENT_IND,
VEHICLE_ID,
VEHICLE_PLATE_REGISTRATION,
VEHICLE_VIN,
VEHICLE_UNIT,
VEHICLE_COLOR,
VEHICLE_YEAR,
VEHICLE_MAKE,
VEHICLE_MODEL,
VEHICLE_SUBMODEL,
VEHICLE_ENGINE,
VEHICLE_TYPE,
VEHICLE_LOOKUP,
VEHICLE_DESCRIPTION,
VEHICLE_USAGE,
VEHICLE_PRODUCTION_DTTIME,
VEHICLE_NOTE,
VEHICLE_NO_EMAIL,
VEHICLE_NO_POSTCARD,
CREATE_DTTIME,
SOURCE_SYSTEM_CD,
JOB_RUN_ID)
SELECT
INVOICE_KEY AS INVOICE_KEY,
MDM.CUSTOMER_MDM_KEY,
BRANCH_CD AS LOCATION_ID,
INVOICE_ID AS INVOICE_ID,
INVOICE_CREATE_DTTIME AS INVOICE_CREATE_DTTIME,
INVOICE_DELETE_DTTIME AS INVOICE_DELETE_DTTIME,
INVOICE_DELETIONTIMESPECIFIED AS INVOICE_DELETION_TIME_SPECIFIED,
INVOICE_LAST_MODIFIED_DTTIME AS INVOICE_LAST_MODIFIED_DTTIME,
INVOICE_LAST_MODIFIED_BY AS INVOICE_LAST_MODIFIED_BY,
INVOICE_TYPE AS INVOICE_TYPE,
INVOICE_SCHEDULED_DTTIME AS INVOICE_SCHEDULED_DTTIME,
INVOICE_PROMISED_DTTIME AS INVOICE_PROMISED_DTTIME,
INVOICE_DTTIME AS INVOICE_DTTIME,
WORK_ORDER_NUM AS WORK_ORDER_NUM,
INVOICE_NUM AS INVOICE_NUM,
PURCHASE_ORDER_NUM AS PURCHASE_ORDER_NUM,
CONTACT_ID AS CONTACT_ID,
MARKETING_SOURCE AS MARKETING_SOURCE,
SERVICE_ITEM_IS_COMPLETE AS SERVICE_ITEM_IS_COMPLETE,
SERVICE_ADVISOR_ID AS SERVICE_ADVISOR_ID,
SERVICE_ADVISOR_TYPE AS SERVICE_ADVISOR_TYPE,
SERVICE_ADVISOR_NM AS SERVICE_ADVISOR_NM,
TECHNICIAN_ID AS TECHNICIAN_ID,
TECHNICIAN_TYPE AS TECHNICIAN_TYPE,
TECHNICIAN_NM AS TECHNICIAN_NM,
INVOICE_DURATION AS INVOICE_DURATION,
INVOICE_IN_USAGE AS INVOICE_IN_USAGE,
INVOICE_OUT_USAGE AS INVOICE_OUT_USAGE,
INVOICE_WORKFLOW_STAGE AS INVOICE_WORKFLOW_STAGE,
INVOICE_SEARCH_STRING AS INVOICE_SEARCH_STRING,
INVOICE_NOTE AS INVOICE_NOTE,
PARTS_TOTAL AS PARTS_TOTAL,
LABOR_TOTAL AS LABOR_TOTAL,
SUBLET_TOTAL AS SUBLET_TOTAL,
NET_TOTAL AS NET_TOTAL,
OTHER_CHARGE_TOTAL AS OTHER_CHARGE_TOTAL,
GRAND_TOTAL AS GRAND_TOTAL,
OTHER_CHARGE_CD AS OTHER_CHARGE_CD,
INVOICE_FLAG AS INVOICE_FLAG,
INVOICE_TAGS AS INVOICE_TAGS,
INVOICE_COMPLETED AS INVOICE_COMPLETED,
SURVEY_SENT_IND AS SURVEY_SENT_IND,
VEHICLE_ID AS VEHICLE_ID,
VEHICLE_PLATE_REGISTRATION AS VEHICLE_PLATE_REGISTRATION,
VEHICLE_VIN AS VEHICLE_VIN,
VEHICLE_UNIT AS VEHICLE_UNIT,
VEHICLE_COLOR AS VEHICLE_COLOR,
VEHICLE_YEAR AS VEHICLE_YEAR,
VEHICLE_MAKE AS VEHICLE_MAKE,
VEHICLE_MODEL AS VEHICLE_MODEL,
VEHICLE_SUBMODEL AS VEHICLE_SUBMODEL,
VEHICLE_ENGINE AS VEHICLE_ENGINE,
VEHICLE_TYPE AS VEHICLE_TYPE,
VEHICLE_LOOKUP AS VEHICLE_LOOKUP,
VEHICLE_DESC AS VEHICLE_DESC,
VEHICLE_USAGE AS VEHICLE_USAGE,
VEHICLE_PRODUCTION_DTTIME AS VEHICLE_PRODUCTION_DTTIME,
VEHICLE_NOTE AS VEHICLE_NOTE,
VEHICLE_NO_EMAIL AS VEHICLE_NO_EMAIL,
VEHICLE_NO_POSTCARD AS VEHICLE_NO_POSTCARD,
STG.CREATE_DTTIME AS CREATE_DTTIME,
'COR' AS SOURCE_SYSTEM_CD,
'v_job_run_id' AS JOB_RUN_ID
FROM LANDING.PROTRACTOR_STAGE_INVOICE STG
LEFT OUTER JOIN (
      SELECT
        *
      FROM (
        SELECT
          *,
          ROW_NUMBER() OVER (PARTITION BY SOURCE_KEY1) RN
        FROM
          CUSTOMER_PRODUCT.MDM_CUSTOMER_BRIDGE
        WHERE
          SOURCE_SYSTEM_CD='COR' )
      WHERE
        RN=1 ) MDM
    ON
      MDM.SOURCE_KEY1=SAFE_CAST(INVOICE_ID AS STRING)
WHERE 	  STG.CREATE_DTTIME > (SELECT MAX(CREATE_DTTIME) FROM CUSTOMER_PRODUCT.COR_TRANSACTION_FACT)
