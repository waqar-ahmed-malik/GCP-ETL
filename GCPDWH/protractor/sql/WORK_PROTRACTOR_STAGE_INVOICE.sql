MERGE INTO 	LANDING.PROTRACTOR_STAGE_INVOICE TGT
USING (
SELECT ROW_NUMBER() OVER() as INVOICE_KEY,
 BRANCH_CD
,BRANCH_NM
,INVOICE_ID
,INVOICE_CREATE_DTTIME
,INVOICE_DELETE_DTTIME
,INVOICE_DELETIONTIMESPECIFIED
,INVOICE_LAST_MODIFIED_DTTIME
,INVOICE_LAST_MODIFIED_BY
,INVOICE_TYPE
,INVOICE_SCHEDULED_DTTIME
,INVOICE_PROMISED_DTTIME
,INVOICE_DTTIME
,WORK_ORDER_NUM
,INVOICE_NUM
,PURCHASE_ORDER_NUM
,CONTACT_ID
,CONTACT_PREFIX
,CONTACT_FIRST_NM
,CONTACT_MIDDLE_NM
,CONTACT_LAST_NM
,CONTACT_SUFFIX
,REGEXP_REPLACE(IFNULL(TRIM(ADDRESS_STREET),' '),r"\r\n",' ') AS ADDRESS_STREET
,CITY
,STATE_CD
,POSTAL_CD
,COUNTRY
,MEMBERSHIP_NUM
,CONTACT_PHONE1_TYPE
,CONTACT_PHONE1
,CONTACT_PHONE2_TYPE
,CONTACT_PHONE2
,CONTACT_EMAIL
,PREFERRED_CONTACT_METHOD
,MARKETING_SOURCE
,CONTACT_NOTE
,CONTACT_NO_EMAIL
,CONTACT_NO_POSTCARD
,SERVICE_ITEM_IS_COMPLETE
,VEHICLE_ID
,VEHICLE_PLATE_REGISTRATION
,VEHICLE_VIN
,VEHICLE_UNIT
,VEHICLE_COLOR
,VEHICLE_YEAR
,VEHICLE_MAKE
,VEHICLE_MODEL
,VEHICLE_SUBMODEL
,VEHICLE_ENGINE
,VEHICLE_TYPE
,VEHICLE_LOOKUP
,VEHICLE_USAGE
,VEHICLE_PRODUCTION_DTTIME
,VEHICLE_NOTE
,VEHICLE_NO_EMAIL
,VEHICLE_NO_POSTCARD
,VEHCILE_OWNER_ID
,SERVICE_ADVISOR_ID
,SERVICE_ADVISOR_TYPE
,SERVICE_ADVISOR_NM
,TECHNICIAN_ID
,TECHNICIAN_TYPE
,TECHNICIAN_NM
,INVOICE_DURATION
,INVOICE_IN_USAGE
,INVOICE_OUT_USAGE
,INVOICE_WORKFLOW_STAGE
,INVOICE_SEARCH_STRING
,INVOICE_NOTE
,PARTS_TOTAL
,LABOR_TOTAL
,SUBLET_TOTAL
,NET_TOTAL
,OTHER_CHARGE_TOTAL
,GRAND_TOTAL
,OTHER_CHARGE_CD
,INVOICE_FLAG
,INVOICE_TAGS
,INVOICE_COMPLETED
,INSERT_DTTIME AS CREATE_DTTIME
,'N' AS SURVEY_SENT_IND
 FROM
(Select * from (SELECT WPI.*
,ROW_NUMBER() OVER(PARTITION BY BRANCH_CD, INVOICE_ID ORDER BY INSERT_DTTIME DESC) RN 
FROM `LANDING.WORK_PROTRACTOR_INVOICE` WPI 
WHERE INSERT_DTTIME > (SELECT MAX(CREATE_DTTIME) FROM LANDING.PROTRACTOR_STAGE_INVOICE)
)
WHERE RN= 1	)

) SRC
ON TGT.INVOICE_ID=SRC.INVOICE_ID
WHEN MATCHED  THEN  UPDATE   SET
TGT.BRANCH_CD=SRC.BRANCH_CD,
TGT.BRANCH_NM=SRC.BRANCH_NM,
TGT.INVOICE_ID=SRC.INVOICE_ID,
TGT.INVOICE_CREATE_DTTIME=SRC.INVOICE_CREATE_DTTIME,
TGT.INVOICE_DELETE_DTTIME=SRC.INVOICE_DELETE_DTTIME,
TGT.INVOICE_DELETIONTIMESPECIFIED=SRC.INVOICE_DELETIONTIMESPECIFIED,
TGT.INVOICE_LAST_MODIFIED_DTTIME=SRC.INVOICE_LAST_MODIFIED_DTTIME,
TGT.INVOICE_LAST_MODIFIED_BY=SRC.INVOICE_LAST_MODIFIED_BY,
TGT.INVOICE_TYPE=SRC.INVOICE_TYPE,
TGT.INVOICE_SCHEDULED_DTTIME=SRC.INVOICE_SCHEDULED_DTTIME,
TGT.INVOICE_PROMISED_DTTIME=SRC.INVOICE_PROMISED_DTTIME,
TGT.INVOICE_DTTIME=SRC.INVOICE_DTTIME,
TGT.WORK_ORDER_NUM=SRC.WORK_ORDER_NUM,
TGT.INVOICE_NUM=SRC.INVOICE_NUM,
TGT.PURCHASE_ORDER_NUM=SRC.PURCHASE_ORDER_NUM,
TGT.CONTACT_ID=SRC.CONTACT_ID,
TGT.CONTACT_PREFIX=SRC.CONTACT_PREFIX,
TGT.CONTACT_FIRST_NM=SRC.CONTACT_FIRST_NM,
TGT.CONTACT_MIDDLE_NM=SRC.CONTACT_MIDDLE_NM,
TGT.CONTACT_LAST_NM=SRC.CONTACT_LAST_NM,
TGT.CONTACT_SUFFIX=SRC.CONTACT_SUFFIX,
TGT.ADDRESS_STREET=REGEXP_REPLACE(IFNULL(TRIM(SRC.ADDRESS_STREET),' '),r"\r\n",' '),
TGT.CITY=SRC.CITY,
TGT.STATE_CD=SRC.STATE_CD,
TGT.POSTAL_CD=SRC.POSTAL_CD,
TGT.COUNTRY=SRC.COUNTRY,
TGT.MEMBERSHIP_NUM=SRC.MEMBERSHIP_NUM,
TGT.CONTACT_PHONE1_TYPE=SRC.CONTACT_PHONE1_TYPE,
TGT.CONTACT_PHONE1=SRC.CONTACT_PHONE1,
TGT.CONTACT_PHONE2_TYPE=SRC.CONTACT_PHONE2_TYPE,
TGT.CONTACT_PHONE2=SRC.CONTACT_PHONE2,
TGT.CONTACT_EMAIL=SRC.CONTACT_EMAIL,
TGT.PREFERRED_CONTACT_METHOD=SRC.PREFERRED_CONTACT_METHOD,
TGT.MARKETING_SOURCE=SRC.MARKETING_SOURCE,
TGT.CONTACT_NOTE=SRC.CONTACT_NOTE,
TGT.CONTACT_NO_EMAIL=SRC.CONTACT_NO_EMAIL,
TGT.CONTACT_NO_POSTCARD=SRC.CONTACT_NO_POSTCARD,
TGT.SERVICE_ITEM_IS_COMPLETE=SRC.SERVICE_ITEM_IS_COMPLETE,
TGT.VEHICLE_ID=SRC.VEHICLE_ID,
TGT.VEHICLE_PLATE_REGISTRATION=SRC.VEHICLE_PLATE_REGISTRATION,
TGT.VEHICLE_VIN=SRC.VEHICLE_VIN,
TGT.VEHICLE_UNIT=SRC.VEHICLE_UNIT,
TGT.VEHICLE_COLOR=SRC.VEHICLE_COLOR,
TGT.VEHICLE_YEAR=SRC.VEHICLE_YEAR,
TGT.VEHICLE_MAKE=SRC.VEHICLE_MAKE,
TGT.VEHICLE_MODEL=SRC.VEHICLE_MODEL,
TGT.VEHICLE_SUBMODEL=SRC.VEHICLE_SUBMODEL,
TGT.VEHICLE_ENGINE=SRC.VEHICLE_ENGINE,
TGT.VEHICLE_TYPE=SRC.VEHICLE_TYPE,
TGT.VEHICLE_LOOKUP=SRC.VEHICLE_LOOKUP,
TGT.VEHICLE_USAGE=SRC.VEHICLE_USAGE,
TGT.VEHICLE_PRODUCTION_DTTIME=SRC.VEHICLE_PRODUCTION_DTTIME,
TGT.VEHICLE_NOTE=SRC.VEHICLE_NOTE,
TGT.VEHICLE_NO_EMAIL=SRC.VEHICLE_NO_EMAIL,
TGT.VEHICLE_NO_POSTCARD=SRC.VEHICLE_NO_POSTCARD,
TGT.VEHCILE_OWNER_ID=SRC.VEHCILE_OWNER_ID,
TGT.SERVICE_ADVISOR_ID=SRC.SERVICE_ADVISOR_ID,
TGT.SERVICE_ADVISOR_TYPE=SRC.SERVICE_ADVISOR_TYPE,
TGT.SERVICE_ADVISOR_NM=SRC.SERVICE_ADVISOR_NM,
TGT.TECHNICIAN_ID=SRC.TECHNICIAN_ID,
TGT.TECHNICIAN_TYPE=SRC.TECHNICIAN_TYPE,
TGT.TECHNICIAN_NM=SRC.TECHNICIAN_NM,
TGT.INVOICE_DURATION=SRC.INVOICE_DURATION,
TGT.INVOICE_IN_USAGE=SRC.INVOICE_IN_USAGE,
TGT.INVOICE_OUT_USAGE=SRC.INVOICE_OUT_USAGE,
TGT.INVOICE_WORKFLOW_STAGE=SRC.INVOICE_WORKFLOW_STAGE,
TGT.INVOICE_SEARCH_STRING=SRC.INVOICE_SEARCH_STRING,
TGT.INVOICE_NOTE=SRC.INVOICE_NOTE,
TGT.PARTS_TOTAL=SRC.PARTS_TOTAL,
TGT.LABOR_TOTAL=SRC.LABOR_TOTAL,
TGT.SUBLET_TOTAL=SRC.SUBLET_TOTAL,
TGT.NET_TOTAL=SRC.NET_TOTAL,
TGT.OTHER_CHARGE_TOTAL=SRC.OTHER_CHARGE_TOTAL,
TGT.GRAND_TOTAL=SRC.GRAND_TOTAL,
TGT.OTHER_CHARGE_CD=SRC.OTHER_CHARGE_CD,
TGT.INVOICE_FLAG=SRC.INVOICE_FLAG,
TGT.INVOICE_TAGS=SRC.INVOICE_TAGS,
TGT.INVOICE_COMPLETED=SRC.INVOICE_COMPLETED,
TGT.CREATE_DTTIME=SRC.CREATE_DTTIME,
TGT.UPDATE_DTTIME = CURRENT_DATETIME()
WHEN NOT MATCHED THEN
  INSERT (
  INVOICE_KEY
  ,BRANCH_CD
,BRANCH_NM
,INVOICE_ID
,INVOICE_CREATE_DTTIME
,INVOICE_DELETE_DTTIME
,INVOICE_DELETIONTIMESPECIFIED
,INVOICE_LAST_MODIFIED_DTTIME
,INVOICE_LAST_MODIFIED_BY
,INVOICE_TYPE
,INVOICE_SCHEDULED_DTTIME
,INVOICE_PROMISED_DTTIME
,INVOICE_DTTIME
,WORK_ORDER_NUM
,INVOICE_NUM
,PURCHASE_ORDER_NUM
,CONTACT_ID
,CONTACT_PREFIX
,CONTACT_FIRST_NM
,CONTACT_MIDDLE_NM
,CONTACT_LAST_NM
,CONTACT_SUFFIX
,ADDRESS_STREET
,CITY
,STATE_CD
,POSTAL_CD
,COUNTRY
,MEMBERSHIP_NUM
,CONTACT_PHONE1_TYPE
,CONTACT_PHONE1
,CONTACT_PHONE2_TYPE
,CONTACT_PHONE2
,CONTACT_EMAIL
,PREFERRED_CONTACT_METHOD
,MARKETING_SOURCE
,CONTACT_NOTE
,CONTACT_NO_EMAIL
,CONTACT_NO_POSTCARD
,SERVICE_ITEM_IS_COMPLETE
,VEHICLE_ID
,VEHICLE_PLATE_REGISTRATION
,VEHICLE_VIN
,VEHICLE_UNIT
,VEHICLE_COLOR
,VEHICLE_YEAR
,VEHICLE_MAKE
,VEHICLE_MODEL
,VEHICLE_SUBMODEL
,VEHICLE_ENGINE
,VEHICLE_TYPE
,VEHICLE_LOOKUP
,VEHICLE_USAGE
,VEHICLE_PRODUCTION_DTTIME
,VEHICLE_NOTE
,VEHICLE_NO_EMAIL
,VEHICLE_NO_POSTCARD
,VEHCILE_OWNER_ID
,SERVICE_ADVISOR_ID
,SERVICE_ADVISOR_TYPE
,SERVICE_ADVISOR_NM
,TECHNICIAN_ID
,TECHNICIAN_TYPE
,TECHNICIAN_NM
,INVOICE_DURATION
,INVOICE_IN_USAGE
,INVOICE_OUT_USAGE
,INVOICE_WORKFLOW_STAGE
,INVOICE_SEARCH_STRING
,INVOICE_NOTE
,PARTS_TOTAL
,LABOR_TOTAL
,SUBLET_TOTAL
,NET_TOTAL
,OTHER_CHARGE_TOTAL
,GRAND_TOTAL
,OTHER_CHARGE_CD
,INVOICE_FLAG
,INVOICE_TAGS
,INVOICE_COMPLETED
,SURVEY_SENT_IND
,CREATE_DTTIME
,UPDATE_DTTIME
,SOURCE_SYSTEM_CD)
VALUES(
SRC.INVOICE_KEY + (SELECT IFNULL(MAX(INVOICE_KEY),0) FROM LANDING.PROTRACTOR_STAGE_INVOICE) 
  ,SRC.BRANCH_CD
,SRC.BRANCH_NM
,SRC.INVOICE_ID
,SRC.INVOICE_CREATE_DTTIME
,SRC.INVOICE_DELETE_DTTIME
,SRC.INVOICE_DELETIONTIMESPECIFIED
,SRC.INVOICE_LAST_MODIFIED_DTTIME
,SRC.INVOICE_LAST_MODIFIED_BY
,SRC.INVOICE_TYPE
,SRC.INVOICE_SCHEDULED_DTTIME
,SRC.INVOICE_PROMISED_DTTIME
,SRC.INVOICE_DTTIME
,SRC.WORK_ORDER_NUM
,SRC.INVOICE_NUM
,SRC.PURCHASE_ORDER_NUM
,SRC.CONTACT_ID
,SRC.CONTACT_PREFIX
,SRC.CONTACT_FIRST_NM
,SRC.CONTACT_MIDDLE_NM
,SRC.CONTACT_LAST_NM
,SRC.CONTACT_SUFFIX
,SRC.ADDRESS_STREET
,SRC.CITY
,SRC.STATE_CD
,SRC.POSTAL_CD
,SRC.COUNTRY
,SRC.MEMBERSHIP_NUM
,SRC.CONTACT_PHONE1_TYPE
,SRC.CONTACT_PHONE1
,SRC.CONTACT_PHONE2_TYPE
,SRC.CONTACT_PHONE2
,SRC.CONTACT_EMAIL
,SRC.PREFERRED_CONTACT_METHOD
,SRC.MARKETING_SOURCE
,SRC.CONTACT_NOTE
,SRC.CONTACT_NO_EMAIL
,SRC.CONTACT_NO_POSTCARD
,SRC.SERVICE_ITEM_IS_COMPLETE
,SRC.VEHICLE_ID
,SRC.VEHICLE_PLATE_REGISTRATION
,SRC.VEHICLE_VIN
,SRC.VEHICLE_UNIT
,SRC.VEHICLE_COLOR
,SRC.VEHICLE_YEAR
,SRC.VEHICLE_MAKE
,SRC.VEHICLE_MODEL
,SRC.VEHICLE_SUBMODEL
,SRC.VEHICLE_ENGINE
,SRC.VEHICLE_TYPE
,SRC.VEHICLE_LOOKUP
,SRC.VEHICLE_USAGE
,SRC.VEHICLE_PRODUCTION_DTTIME
,SRC.VEHICLE_NOTE
,SRC.VEHICLE_NO_EMAIL
,SRC.VEHICLE_NO_POSTCARD
,SRC.VEHCILE_OWNER_ID
,SRC.SERVICE_ADVISOR_ID
,SRC.SERVICE_ADVISOR_TYPE
,SRC.SERVICE_ADVISOR_NM
,SRC.TECHNICIAN_ID
,SRC.TECHNICIAN_TYPE
,SRC.TECHNICIAN_NM
,SRC.INVOICE_DURATION
,SRC.INVOICE_IN_USAGE
,SRC.INVOICE_OUT_USAGE
,SRC.INVOICE_WORKFLOW_STAGE
,SRC.INVOICE_SEARCH_STRING
,SRC.INVOICE_NOTE
,SRC.PARTS_TOTAL
,SRC.LABOR_TOTAL
,SRC.SUBLET_TOTAL
,SRC.NET_TOTAL
,SRC.OTHER_CHARGE_TOTAL
,SRC.GRAND_TOTAL
,SRC.OTHER_CHARGE_CD
,SRC.INVOICE_FLAG
,SRC.INVOICE_TAGS
,SRC.INVOICE_COMPLETED
,SRC.SURVEY_SENT_IND
,SRC.CREATE_DTTIME
,CURRENT_DATETIME()
,'COR')
