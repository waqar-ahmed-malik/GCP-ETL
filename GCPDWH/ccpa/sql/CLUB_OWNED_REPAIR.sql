MERGE COMPLIANCE.CCPA_CUSTOMER_DETAILS AS TGT
USING (
SELECT CUSTOMER_MDM_KEY, INVOICE_ID , SOURCE_SYSTEM_CD, STRING_AGG(distinct VEHICLE_VIN, '|' ) as VEHICLE_VIN, STRING_AGG(distinct VEHICLE_LOOKUP, '|' ) as VEHICLE_LOOKUP
FROM `aaa-mwg-dwprod.CUSTOMER_PRODUCT.COR_TRANSACTION_FACT`
WHERE CUSTOMER_MDM_KEY IS NOT NULL
group by CUSTOMER_MDM_KEY, INVOICE_ID, SOURCE_SYSTEM_CD
) AS SRC
ON TGT.CUSTOMER_MDM_KEY = CAST(SRC.MDM_CUSTOMER_KEY AS INT64) and
TGT.SOURCE_KEY = SRC.INVOICE_ID and
TGT.SOURCE_SYSTEM_CD = SRC.SOURCE_SYSTEM_CD
WHEN MATCHED THEN UPDATE SET
TGT.VEHICLE_IDENTIFIERS_NUM = SRC.VEHICLE_VIN
,TGT.VEHICLE_LICENSE_PLATE_NUM = SRC.VEHICLE_LOOKUP
,TGT.UPDATE_DTTIME =  CURRENT_DATETIME()
WHEN NOT MATCHED THEN INSERT
(CUSTOMER_MDM_KEY
,SOURCE_KEY
,VEHICLE_IDENTIFIERS_NUM
,VEHICLE_LICENSE_PLATE_NUM
,COMPANY
,SOURCE_SYSTEM_CD
,CREATE_DTTIME
,UPDATE_DTTIME)
VALUES(
CAST(SRC.MDM_CUSTOMER_KEY AS INT64) ,
INVOICE_ID,
VEHICLE_VIN,
VEHICLE_LOOKUP,
'AAA MWG',
SOURCE_SYSTEM_CD,
CURRENT_DATETIME(),
CURRENT_DATETIME())