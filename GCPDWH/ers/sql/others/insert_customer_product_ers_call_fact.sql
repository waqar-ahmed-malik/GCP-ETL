INSERT INTO CUSTOMER_PRODUCT.ERS_CALL_FACT
(COMMUNICATION_CENTER_ID,
SC_DT,
SC_ID,
ARCHIVE_DATE,
BREAKDOWN_LOCATION_NEAR_CITY,
BREAKDOWN_LOCATION_STATE,
CALL_SOURCE,
SERVICE_TRUCK_DRIVER_ID,
DETAIL_PROB1_CD,
DETAIL_PROB_RESOLUTION_CD,
INTERNAL_FACILITY_ID,
PAY_ID,
PLUS_MEMBER_IND,
PROB1_CD,
SC_SERVICE_TRUCK_ID,
SC_PROMISE_ARRIVAL_TM,
SC_RECEIVED_TM,
SC_STATUS_UPDATE_REASON,
SC_VEHICLE_MANUFACTURER,
SC_VEHICLE_MODEL,
SC_VEHICLE_TYPE,
STATUS_CD,
SUSPENDED,
ACCOUNTING_DT,
AUDIT_FLAG,
AUDITOR,
IS_DIESEL,
ELECTRIC_VEHICLE,
HYBRID_VEHICLE,
BREAKDOWN_LOCATION_ZIP,
BREAKDOWN_LOCATION_LAT,
BREAKDOWN_LOCATION_LONG,
DRIVER_NM,
SERVICE_FACILITY_ID,
TOW_DESTINATION_LAT,
TOW_DESTINATION_LONG,
CALCULATED_TOW_MILEAGE,
FIRST_FACILITY_ID,
FIRST_CALL_CLEAR_TM,
FIRST_CALL_DISPATCH_TM,
FIRST_EN_ROUTE_TM,
FIRST_ON_LOCATION_TM,
FIRST_CALL_SPOT_TM,
FIRST_TOW_TM,
LAST_FACILITY_CALL_SPOTTED_TO,
LAST_EMPLOYEE_WHO_ASSIGNED_CALL,
LAST_ASSIGNED_REASON_CD,
LAST_EMPLOYEE_WHO_CLOSED_CALL,
LAST_CLOSED_CALL_TM,
LAST_EMPLOYEE_WHO_DISPATCHED_CALL,
LAST_ON_LOCATION_TM,
LAST_SPOT_REASON_CD,
LAST_TIME_CALL_SPOTTED,
CALL_RECEIVED_TM,
BATTERY_ASSIST_TRUCK,
TRUCK_TYPE_CD,
DOING_BUSINESS_AS,
MEMBER_NUM,
MEMBERSHIP_NUM,
MEMBER_ASSOCIATED_ID,
CLUB_CD,
DRIVER_SHIFT_START_END_TM,
SERVICE_FACILITY_STATE,
SERVICE_FACILITY_CITY,
SERVICE_FACILITY_STATUS,
CALL_COST,
SERVICE_FACILITY_NM,
SC_STATUS_UPDATE_CD,
ETL_JOB_RUN_ID,
SOURCE_SYSTEM_CD,
CREATE_DT,
UPDATE_DT,
CREATE_BY)
SELECT
  COMM_CTR_ID,
  SC_DT,
  SC_ID,
  ARCH_DT,
  BL_NEAR_CTY_NM,
  BL_STATE_CD,
  CALL_SOURCE,
  SC_A_SVC_TRK_D_ID,
  DTL_PROB1_CD,
  DTL_STS_RSN_CD,
  SAFE_CAST(FACIL_INT_ID AS INT64),
  PAY_ID,
  PLUS_IND,
  PROB1_CD,
  SC_A_SVC_TRK_ID,
  SC_PRMS_ARR_TM,
  PARSE_DATE('%m/%d/%Y',SUBSTR(SC_RCVD_TM,1,10)),
  SC_STS_RSN_CD,
  SC_VEH_MANFR_NM,
  SC_VEH_MDL_NM,
  SC_VEH_TYPE,
  STATUS_CD,
  SUSPENDED,
  ACCOUNTING_DT,
  AUDIT_FLAG,
  AUDITOR,
  IS_DIESEL,
  ELECTRIC_VEHICLE,
  HYBRID_VEHICLE,
  BL_ZIP,
  BL_LAT,
  BL_LONG,
  DRIVER_NM,
  SVC_FACL_ID,
  SAFE_CAST(TD_LAT AS STRING),
  SAFE_CAST(TD_LONG AS STRING),
  SAFE_CAST(MILES_TW_CALC AS STRING),
  FIRST_FACL_ID,
  FST_CL_TM,
  FST_DI_TM,
  FST_ER_TM,
  FST_OL_TM,
  FST_SP_TM,
  FST_TW_TM,
  LAST_FACL_ID,
  LST_AS_EMPLE_ID,
  LST_AS_STS_RSN_CD,
  LST_CL_EMPLE_ID,
  LST_CL_TM,
  LST_DI_EMPLE_ID,
  LST_OL_TM,
  LST_SP_STS_RSN_CD,
  LST_SP_TM,
  RE_TM,
  BATTERY_INDIC,
  TRK_TYPE_CD,
  SVCF_DBA_NM,
  SC_CALL_MBR_ID,
  CASE
    WHEN LENGTH(SC_CALL_MBR_ID)<16 THEN CONCAT(SUBSTR(V_MEMBER_NUM,1,15),SAFE_CAST(V_MEMBER_NUM_CHK_DIGIT AS STRING))
    ELSE SC_CALL_MBR_ID
  END AS MEMBERSHIP_NUM,
  SC_CALL_ASC_ID,
  SC_CALL_CLB_CD,
  SVC_FACL_D_S_E_TM,
  SVC_FACL_ST_CD,
  SVC_FACL_CTY_NM,
  SVC_FACL_STS_CD,
  SAFE_CAST(SUM(SVCP_TOT_COST) AS STRING) AS SVCP_TOT_COST,
  SVC_FACL_NM,
  SC_STS_UPD_CD,
  NULL,
  '',
  CURRENT_DATE(),
  CURRENT_DATE(),
  ''
FROM (
  SELECT
    COMM_CTR_ID,
    SC_DT,
    SC_ID,
    ARCH_DT,
    BL_NEAR_CTY_NM,
    BL_STATE_CD,
    CALL_SOURCE,
    SC_A_SVC_TRK_D_ID,
    DTL_PROB1_CD,
    DTL_STS_RSN_CD,
    FACIL_INT_ID,
    PAY_ID,
    PLUS_IND,
    PROB1_CD,
    SC_A_SVC_TRK_ID,
    SC_PRMS_ARR_TM,
    SC_RCVD_TM,
    SC_STS_RSN_CD,
    SC_VEH_MANFR_NM,
    SC_VEH_MDL_NM,
    SC_VEH_TYPE,
    STATUS_CD,
    SUSPENDED,
    ACCOUNTING_DT,
    AUDIT_FLAG,
    AUDITOR,
    IS_DIESEL,
    ELECTRIC_VEHICLE,
    HYBRID_VEHICLE,
    BL_ZIP,
    BL_LAT,
    BL_LONG,
    DRIVER_NM,
    SVC_FACL_ID,
    TD_LAT,
    TD_LONG,
    MILES_TW_CALC,
    FIRST_FACL_ID,
    FST_CL_TM,
    FST_DI_TM,
    FST_ER_TM,
    FST_OL_TM,
    FST_SP_TM,
    FST_TW_TM,
    LAST_FACL_ID,
    LST_AS_EMPLE_ID,
    LST_AS_STS_RSN_CD,
    LST_CL_EMPLE_ID,
    LST_CL_TM,
    LST_DI_EMPLE_ID,
    LST_OL_TM,
    LST_SP_STS_RSN_CD,
    LST_SP_TM,
    RE_TM,
    BATTERY_INDIC,
    TRK_TYPE_CD,
    SVCF_DBA_NM,
    SC_CALL_MBR_ID,
    CASE
      WHEN MOD(SAFE_CAST(v_CHECK_DIGIT AS INT64),10)=0 THEN 0
      ELSE 10-MOD(SAFE_CAST(v_CHECK_DIGIT AS INT64),10)
    END V_MEMBER_NUM_CHK_DIGIT,
    V_MEMBER_NUM,
    SC_CALL_ASC_ID,
    SC_CALL_CLB_CD,
    SVC_FACL_D_S_E_TM,
    SVC_FACL_ST_CD,
    SVC_FACL_CTY_NM,
    SVC_FACL_STS_CD,
    SVCP_TOT_COST,
    SVC_FACL_NM,
    SC_STS_UPD_CD
  FROM (
    SELECT
      COMM_CTR_ID,
      SC_DT,
      SC_ID,
      ARCH_DT,
      BL_NEAR_CTY_NM,
      BL_STATE_CD,
      CALL_SOURCE,
      SC_A_SVC_TRK_D_ID,
      DTL_PROB1_CD,
      DTL_STS_RSN_CD,
      FACIL_INT_ID,
      PAY_ID,
      PLUS_IND,
      PROB1_CD,
      SC_A_SVC_TRK_ID,
      SC_PRMS_ARR_TM,
      SC_RCVD_TM,
      SC_STS_RSN_CD,
      SC_VEH_MANFR_NM,
      SC_VEH_MDL_NM,
      SC_VEH_TYPE,
      STATUS_CD,
      SUSPENDED,
      ACCOUNTING_DT,
      AUDIT_FLAG,
      AUDITOR,
      IS_DIESEL,
      ELECTRIC_VEHICLE,
      HYBRID_VEHICLE,
      BL_ZIP,
      BL_LAT,
      BL_LONG,
      DRIVER_NM,
      SVC_FACL_ID,
      TD_LAT,
      TD_LONG,
      MILES_TW_CALC,
      FIRST_FACL_ID,
      FST_CL_TM,
      FST_DI_TM,
      FST_ER_TM,
      FST_OL_TM,
      FST_SP_TM,
      FST_TW_TM,
      LAST_FACL_ID,
      LST_AS_EMPLE_ID,
      LST_AS_STS_RSN_CD,
      LST_CL_EMPLE_ID,
      LST_CL_TM,
      LST_DI_EMPLE_ID,
      LST_OL_TM,
      LST_SP_STS_RSN_CD,
      LST_SP_TM,
      RE_TM,
      BATTERY_INDIC,
      TRK_TYPE_CD,
      SVCF_DBA_NM,
      SC_CALL_MBR_ID,
      CASE
        WHEN SAFE_CAST(SUBSTR(V_MEMBER_NUM,1,1) AS INT64)*2>9 THEN 1+MOD(SAFE_CAST(SUBSTR(V_MEMBER_NUM,1,1) AS INT64)*2,10)
        ELSE SAFE_CAST(SUBSTR(V_MEMBER_NUM,1,1) AS INT64)*2
      END + SAFE_CAST(SUBSTR(V_MEMBER_NUM,2,1) AS INT64)+
      CASE
        WHEN SAFE_CAST(SUBSTR(V_MEMBER_NUM,3,1) AS INT64)*2>9 THEN 1+MOD(SAFE_CAST(SUBSTR(V_MEMBER_NUM,3,1) AS INT64)*2,10)
        ELSE SAFE_CAST(SUBSTR(V_MEMBER_NUM,3,1) AS INT64)*2
      END + SAFE_CAST(SUBSTR(V_MEMBER_NUM,4,1) AS INT64)+
      CASE
        WHEN SAFE_CAST(SUBSTR(V_MEMBER_NUM,5,1) AS INT64)*2>9 THEN 1+MOD(SAFE_CAST(SUBSTR(V_MEMBER_NUM,5,1) AS INT64)*2,10)
        ELSE SAFE_CAST(SUBSTR(V_MEMBER_NUM,5,1) AS INT64)*2
      END + SAFE_CAST(SUBSTR(V_MEMBER_NUM,6,1) AS INT64)+
      CASE
        WHEN SAFE_CAST(SUBSTR(V_MEMBER_NUM,7,1) AS INT64)*2>9 THEN 1+MOD(SAFE_CAST(SUBSTR(V_MEMBER_NUM,7,1) AS INT64)*2,10)
        ELSE SAFE_CAST(SUBSTR(V_MEMBER_NUM,7,1) AS INT64)*2
      END + SAFE_CAST(SUBSTR(V_MEMBER_NUM,8,1) AS INT64)+
      CASE
        WHEN SAFE_CAST(SUBSTR(V_MEMBER_NUM,9,1) AS INT64)*2>9 THEN 1+MOD(SAFE_CAST(SUBSTR(V_MEMBER_NUM,9,1) AS INT64)*2,10)
        ELSE SAFE_CAST(SUBSTR(V_MEMBER_NUM,9,1) AS INT64)*2
      END + SAFE_CAST(SUBSTR(V_MEMBER_NUM,10,1) AS INT64)+
      CASE
        WHEN SAFE_CAST(SUBSTR(V_MEMBER_NUM,11,1) AS INT64)*2>9 THEN 1+MOD(SAFE_CAST(SUBSTR(V_MEMBER_NUM,11,1) AS INT64)*2,10)
        ELSE SAFE_CAST(SUBSTR(V_MEMBER_NUM,11,1) AS INT64)*2
      END + SAFE_CAST(SUBSTR(V_MEMBER_NUM,12,1) AS INT64)+
      CASE
        WHEN SAFE_CAST(SUBSTR(V_MEMBER_NUM,13,1) AS INT64)*2>9 THEN 1+MOD(SAFE_CAST(SUBSTR(V_MEMBER_NUM,13,1) AS INT64)*2,10)
        ELSE SAFE_CAST(SUBSTR(V_MEMBER_NUM,13,1) AS INT64)*2
      END + SAFE_CAST(SUBSTR(V_MEMBER_NUM,14,1) AS INT64)+
      CASE
        WHEN SAFE_CAST(SUBSTR(V_MEMBER_NUM,15,1) AS INT64)*2>9 THEN 1+MOD(SAFE_CAST(SUBSTR(V_MEMBER_NUM,15,1) AS INT64)*2,10)
        ELSE SAFE_CAST(SUBSTR(V_MEMBER_NUM,15,1) AS INT64)*2
      END AS V_CHECK_DIGIT,
      V_MEMBER_NUM,
      SC_CALL_ASC_ID,
      SC_CALL_CLB_CD,
      SVC_FACL_D_S_E_TM,
      SVC_FACL_ST_CD,
      SVC_FACL_CTY_NM,
      SVC_FACL_STS_CD,
      SVCP_TOT_COST,
      SVC_FACL_NM,
      SC_STS_UPD_CD
    FROM (
      SELECT
        AC.COMM_CTR_ID,
        AC.SC_DT,
        AC.SC_ID,
        SAFE_CAST(AC.ARCH_DATE AS STRING) AS ARCH_DATE,
        AC.BL_NEAR_CTY_NM,
        AC.BL_STATE_CD,
        AC.CALL_SOURCE,
        AC.SC_A_SVC_TRK_D_ID,
        AC.DTL_PROB1_CD,
        AC.DTL_STS_RSN_CD,
        SFD.FACIL_INT_ID,
        AC.PAY_ID,
        AC.PLUS_IND,
        AC.PROB1_CD,
        AC.SC_A_SVC_TRK_ID,
        AC.SC_PRMS_ARR_TM,
        AC.SC_RCVD_TM,
        AC.SC_STS_RSN_CD,
        AC.SC_VEH_MANFR_NM,
        AC.SC_VEH_MDL_NM,
        AC.SC_VEH_TYPE,
        AC.STATUS_CD,
        AC.SUSPENDED,
        ACE.ACCOUNTING_DATE,
        ACE.AUDIT_FLAG,
        ACE.AUDITOR,
        ACE.IS_DIESEL,
        ACE.ELECTRIC_VEHICLE,
        ACE.HYBRID_VEHICLE,
        SAFE_CAST(AC.BL_ZIP AS STRING) AS BL_ZIP,
        SAFE_CAST(ACE.BL_LAT AS STRING) AS BL_LAT,
        SAFE_CAST(ACE.BL_LONG AS STRING)AS BL_LONG,
        ACE.DRIVER_NAME,
        ACE.SVC_FACL_ID,
        ACE.TD_LAT,
        ACE.TD_LONG,
        MH.MILES_TW_CALC,
        RD.FIRST_FACL_ID,
        RD.FST_CL_TM,
        RD.FST_DI_TM,
        RD.FST_ER_TM,
        RD.FST_OL_TM,
        RD.FST_SP_TM,
        RD.FST_TW_TM,
        RD.LAST_FACL_ID,
        RD.LST_AS_EMPLE_ID,
        RD.LST_AS_STS_RSN_CD,
        RD.LST_CL_EMPLE_ID,
        RD.LST_CL_TM,
        RD.LST_DI_EMPLE_ID,
        RD.LST_OL_TM,
        RD.LST_SP_STS_RSN_CD,
        RD.LST_SP_TM,
        RD.RE_TM,
        ST.BATTERY_INDIC,
        ST.TRK_TYP_CD,
        SFD.SVCF_DBA_NM,
        AC.SC_CALL_MBR_ID,
        SUBSTR( CONCAT('429',LPAD(LTRIM(RTRIM(SAFE_CAST(AC.SC_CALL_CLB_CD AS STRING))),
              3,
              '0'), LTRIM(RTRIM(AC.SC_CALL_MBR_ID)),LTRIM(RTRIM(SAFE_CAST(AC.SC_CALL_ASC_ID AS STRING)))), 1,15) AS V_MEMBER_NUM,
        AC.SC_CALL_ASC_ID,
        AC.SC_CALL_CLB_CD,
        SF.SVC_FACL_D_S_E_TM,
        SF.SVC_FACL_ST_CD,
        SF.SVC_FACL_CTY_NM,
        SF.SVC_FACL_STS_CD,
        SP.SVCP_TOT_COST,
        SF.SVC_FACL_NM,
        SC.SC_STS_UPD_CD
      FROM
        OPERATIONAL.ERS_STAGE_ARCH_CALL AC
      JOIN
        OPERATIONAL.ERS_STAGE_ARCH_CALL_EXTD ACE
      ON
        (AC.COMM_CTR_ID = ACE.COMM_CTR_ID
          AND AC.SC_DT = ACE.SC_DT
          AND AC.SC_ID = ACE.SC_ID)
      JOIN
        OPERATIONAL.ERS_STAGE_MILEAGE_HIST MH
      ON
        (AC.COMM_CTR_ID = MH.COMM_CTR_ID
          AND AC.SC_DT = MH.SC_DT
          AND AC.SC_ID = MH.SC_ID)
      LEFT JOIN
        OPERATIONAL.ERS_STAGE_SC_STATUS SC
      ON
        (AC.SC_DT = SC.SC_DT
          AND AC.SC_ID = SC.SC_ID
          AND AC.COMM_CTR_ID = SC.COMM_CTR_ID)
      LEFT JOIN
        OPERATIONAL.ERS_STAGE_SERVICE_TRUCK ST
      ON
        (SC.SC_FACL_ID = ST.SVC_FACL_ID
          AND SC.SC_TRK_ID = ST.TRK_ID)
       LEFT JOIN OPERATIONAL.ERS_STAGE_SVC_FAC_DBA SFD ON (AC.FACIL_INT_ID = SFD.FACIL_INT_ID)
      LEFT JOIN
        OPERATIONAL.ERS_STAGE_SERVICE_FACILITY SF
      ON
        (AC.FACIL_INT_ID = SF.FACIL_INT_ID)
      LEFT JOIN
        OPERATIONAL.ERS_STAGE_REPORTS_DATA RD
      ON
        (AC.COMM_CTR_ID = RD.COMM_CTR_ID
          AND AC.SC_DT = RD.SC_DT
          AND AC.SC_ID = RD.SC_ID)
      LEFT JOIN
        OPERATIONAL.ERS_STAGE_SERVICE_PROVIDED SP
      ON
        (AC.COMM_CTR_ID = SP.COMM_CTR_ID
          AND AC.SC_DT = SP.SC_DT
          AND AC.SC_ID = SP.SC_ID) ) ) )
GROUP BY
  COMM_CTR_ID,
  SC_DT,
  SC_ID,
  ARCH_DT,
  BL_NEAR_CTY_NM,
  BL_STATE_CD,
  CALL_SOURCE,
  SC_A_SVC_TRK_D_ID,
  DTL_PROB1_CD,
  DTL_STS_RSN_CD,
  SAFE_CAST(FACIL_INT_ID AS INT64),
  PAY_ID,
  PLUS_IND,
  PROB1_CD,
  SC_A_SVC_TRK_ID,
  SC_PRMS_ARR_TM,
  PARSE_DATE('%m/%d/%Y',SUBSTR(SC_RCVD_TM,1,10)),
  SC_STS_RSN_CD,
  SC_VEH_MANFR_NM,
  SC_VEH_MDL_NM,
  SC_VEH_TYPE,
  STATUS_CD,
  SUSPENDED,
  ACCOUNTING_DT,
  AUDIT_FLAG,
  AUDITOR,
  IS_DIESEL,
  ELECTRIC_VEHICLE,
  HYBRID_VEHICLE,
  BL_ZIP,
  BL_LAT,
  BL_LONG,
  DRIVER_NM,
  SVC_FACL_ID,
  SAFE_CAST(TD_LAT AS STRING),
  SAFE_CAST(TD_LONG AS STRING),
  SAFE_CAST(MILES_TW_CALC AS STRING),
  FIRST_FACL_ID,
  FST_CL_TM,
  FST_DI_TM,
  FST_ER_TM,
  FST_OL_TM,
  FST_SP_TM,
  FST_TW_TM,
  LAST_FACL_ID,
  LST_AS_EMPLE_ID,
  LST_AS_STS_RSN_CD,
  LST_CL_EMPLE_ID,
  LST_CL_TM,
  LST_DI_EMPLE_ID,
  LST_OL_TM,
  LST_SP_STS_RSN_CD,
  LST_SP_TM,
  RE_TM,
  BATTERY_INDIC,
  TRK_TYP_CD,
  SVCF_DBA_NM,
  SC_CALL_MBR_ID,
  CASE
    WHEN LENGTH(SC_CALL_MBR_ID)<16 THEN CONCAT(SUBSTR(V_MEMBER_NUM,1,15),SAFE_CAST(V_MEMBER_NUM_CHK_DIGIT AS STRING))
    ELSE SC_CALL_MBR_ID
  END,
  SC_CALL_ASC_ID,
  SC_CALL_CLB_CD,
  SVC_FACL_D_S_E_TM,
  SVC_FACL_ST_CD,
  SVC_FACL_CTY_NM,
  SVC_FACL_STS_CD,
  SVC_FACL_NM,
  SC_STS_UPD_CD;