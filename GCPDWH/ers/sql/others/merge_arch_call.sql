-- UPDATE(MERGE)

--MERGE <target_table> [AS TARGET]
--USING <table_source> [AS SOURCE]
--ON <search_condition>
--[WHEN MATCHED 
--THEN <merge_matched> ]
--[WHEN NOT MATCHED [BY TARGET]
--THEN <merge_not_matched> ]
--[WHEN NOT MATCHED BY SOURCE
--THEN <merge_matched> ];
  
--ERS_STAGE_ARCH_CALL
--WORK_ERS_STG_ARCH_CALL
MERGE OPERATIONAL.ERS_STAGE_ARCH_CALL AS TGT
USING LANDING.WORK_ERS_STG_ARCH_CALL AS SRC
ON TGT.COMM_CTR_ID = SRC.COMM_CTR_ID and
CAST(TGT.SC_DT AS STRING) = SRC.SC_DT and
CAST(TGT.SC_ID AS STRING) = SRC.SC_ID
WHEN MATCHED
THEN UPDATE SET
TGT.COMM_CTR_ID = SRC.COMM_CTR_ID ,  
TGT.SC_DT = CAST (SRC.SC_DT AS DATETIME) , 
TGT.SC_ID = CAST(SRC.SC_ID AS INT64), 
TGT.ARCH_DATETIME =CAST( SRC.ARCH_DATE AS DATETIME) , 
TGT.SC_CALL_CLB_CD = SRC.SC_CALL_CLB_CD , 
TGT.SC_CALL_MBR_ID = SRC.SC_CALL_MBR_ID , 
TGT.SC_CALL_ASC_ID = SRC.SC_CALL_ASC_ID , 
TGT.SC_CSH_RQR_IN = SRC.SC_CSH_RQR_IN , 
TGT.SC_CNTC_FST_NM = SRC.SC_CNTC_FST_NM , 
TGT.SC_CNTC_LST_NM = SRC.SC_CNTC_LST_NM , 
TGT.SC_CNTC_SUFFIX = SRC.SC_CNTC_SUFFIX , 
TGT.SC_PRTY_CD = SRC.SC_PRTY_CD , 
TGT.SC_WAIT_TM = CAST (SRC.SC_WAIT_TM AS INT64), 
TGT.SC_PRMS_ARR_TM = CAST(SRC.SC_PRMS_ARR_TM AS DATETIME), 
TGT.SC_RED_FLAG_IN = SRC.SC_RED_FLAG_IN , 
TGT.STATUS_CD = SRC.STATUS_CD , 
TGT.SC_STS_RSN_CD = SRC.SC_STS_RSN_CD , 
TGT.CB_FLAG = SRC.CB_FLAG , 
TGT.SC_RCVD_TM = CAST(SRC.SC_RCVD_TM AS DATETIME), 
TGT.HIST_FLAG = SRC.HIST_FLAG , 
TGT.SC_POLICY = SRC.SC_POLICY , 
TGT.SC_SRC_CD = SRC.SC_SRC_CD , 
TGT.HOLD_FOR_CALLBK = SRC.HOLD_FOR_CALLBK , 
TGT.CB_MEMBER = SRC.CB_MEMBER , 
TGT.CB_REQ_MIN = CAST (SRC.CB_REQ_MIN AS INT64), 
TGT.SC_VEH_LIC_ST_CD = SRC.SC_VEH_LIC_ST_CD , 
TGT.SC_VEH_LIC_TAG_NR = SRC.SC_VEH_LIC_TAG_NR , 
TGT.SC_VEH_MANF_YR_DT = SRC.SC_VEH_MANF_YR_DT , 
TGT.SC_VEH_MANFR_NM = SRC.SC_VEH_MANFR_NM , 
TGT.SC_VEH_MDL_NM = SRC.SC_VEH_MDL_NM , 
TGT.SC_VEH_COLR_NM = SRC.SC_VEH_COLR_NM , 
TGT.BL_NEAR_CTY_NM = SRC.BL_NEAR_CTY_NM , 
TGT.BL_N_LNDMRK_TX = SRC.BL_N_LNDMRK_TX , 
TGT.BL_OOT_IN = SRC.BL_OOT_IN , 
TGT.BL_TEL_NR_EXT = SRC.BL_TEL_NR_EXT , 
TGT.BL_TYP_CD = SRC.BL_TYP_CD , 
TGT.BL_AREA = SRC.BL_AREA , 
TGT.BL_UPARS_TX = SRC.BL_UPARS_TX , 
TGT.BL_STATE_CD = SRC.BL_STATE_CD , 
TGT.SVC_REGN_GRID_ID = SRC.SVC_REGN_GRID_ID , 
TGT.TOW_DST_UPRS_TX = SRC.TOW_DST_UPRS_TX , 
TGT.FACIL_INT_ID = CAST(SRC.FACIL_INT_ID AS INT64) , 
TGT.SC_A_SVC_TRK_ID = SRC.SC_A_SVC_TRK_ID , 
TGT.SC_A_SVC_TRK_D_ID = SRC.SC_A_SVC_TRK_D_ID , 
TGT.SC_REASGN_RSN_CD = SRC.SC_REASGN_RSN_CD , 
TGT.PROB1_CD = SRC.PROB1_CD , 
TGT.PROB2_CD = SRC.PROB2_CD , 
TGT.CSH_COLL = CAST(SRC.CSH_COLL AS FLOAT64) , 
TGT.STATUS_CHGS = SRC.STATUS_CHGS , 
TGT.EMPLE_ID = SRC.EMPLE_ID , 
TGT.SC_CNTC_EXP_DT_YR = CAST(SRC.SC_CNTC_EXP_DT_YR AS DATETIME), 
TGT.PLUS_IND = SRC.PLUS_IND , 
TGT.CHG_ENTITLEMENT = SRC.CHG_ENTITLEMENT , 
TGT.BATCH_CD = SRC.BATCH_CD , 
TGT.MMP_CD = SRC.MMP_CD , 
TGT.SC_SVC_TIK_NO = SRC.SC_SVC_TIK_NO , 
TGT.SC_TOD_IND = SRC.SC_TOD_IND , 
TGT.SC_PROB_IND = SRC.SC_PROB_IND , 
TGT.RATE_CATEGORY = SRC.RATE_CATEGORY , 
TGT.CALL_SOURCE = SRC.CALL_SOURCE , 
TGT.CALL_COST = CAST(SRC.CALL_COST AS FLOAT64) , 
TGT.MILES_START = CAST(SRC.MILES_START AS FLOAT64) , 
TGT.MILES_ONLC = CAST(SRC.MILES_ONLC AS FLOAT64) , 
TGT.MILES_DEST = CAST (SRC.MILES_DEST AS FLOAT64), 
TGT.PAY_ID = CAST (SRC.PAY_ID AS INT64) , 
TGT.SUSPENDED = CAST(SRC.SUSPENDED AS STRING) , 
TGT.RECIPROCALIZED = SRC.RECIPROCALIZED , 
TGT.DTL_PROB1_CD = SRC.DTL_PROB1_CD , 
TGT.DTL_PROB2_CD = SRC.DTL_PROB2_CD , 
TGT.DTL_STS_RSN_CD = SRC.DTL_STS_RSN_CD , 
TGT.SC_VEH_TYPE = SRC.SC_VEH_TYPE , 
TGT.SPP_TKT = SRC.SPP_TKT , 
TGT.SPP_CADJ = SRC.SPP_CADJ , 
TGT.SC_TRC_FLAG = SRC.SC_TRC_FLAG , 
TGT.SC_TD_TYPE = SRC.SC_TD_TYPE , 
TGT.BL_TIMEZONE = SRC.BL_TIMEZONE , 
TGT.BL_ZIP = CAST (SRC.BL_ZIP AS INT64), 
TGT.BL_ZIP4 = CAST (SRC.BL_ZIP4 AS INT64) , 
TGT.HIGHWAY_CALL = SRC.HIGHWAY_CALL , 
TGT.MILE_MARKER = CAST (SRC.MILE_MARKER AS INT64) , 
TGT.CALLBOX = SRC.CALLBOX , 
TGT.BL_VERIFIED_LOC = SRC.BL_VERIFIED_LOC , 
TGT.AA_VERIFIED_LOC = SRC.AA_VERIFIED_LOC , 
TGT.ACCIDENT_ASSIST_FLAG = SRC.ACCIDENT_ASSIST_FLAG , 
TGT.PUBLIC_FLAG = SRC.PUBLIC_FLAG , 
TGT.TD_VERIFIED_LOC = SRC.TD_VERIFIED_LOC , 
TGT.ER_DIRECTIONS = SRC.ER_DIRECTIONS , 
TGT.TOW_DIRECTIONS = SRC.TOW_DIRECTIONS , 
TGT.SC_VEH_ODOMETER = CAST (SRC.SC_VEH_ODOMETER AS FLOAT64) , 
TGT.SC_VEH_VIN = SRC.SC_VEH_VIN , 
TGT.ETL_JOB_RUN_ID = CAST(SRC.JOB_RUN_ID AS INT64), 
TGT.SOURCE_SYSTEM_CD = SRC.SOURCE_SYSTEM_CD ,  
TGT.CREATE_DTTIME = current_datetime() ,
TGT.CREATE_BY = SRC.CREATED_BY ,
TGT.LAST_UPDATE_DTTIME = current_datetime() ,
TGT.LAST_UPDATE_BY = "Last updated by"

WHEN NOT MATCHED THEN INSERT 
(
COMM_CTR_ID , 
SC_DT , 
SC_ID , 
ARCH_DATETIME , 
SC_CALL_CLB_CD , 
SC_CALL_MBR_ID , 
SC_CALL_ASC_ID , 
SC_CSH_RQR_IN , 
SC_CNTC_FST_NM , 
SC_CNTC_LST_NM , 
SC_CNTC_SUFFIX , 
SC_PRTY_CD , 
SC_WAIT_TM , 
SC_PRMS_ARR_TM , 
SC_RED_FLAG_IN , 
STATUS_CD , 
SC_STS_RSN_CD , 
CB_FLAG , 
SC_RCVD_TM , 
HIST_FLAG , 
SC_POLICY , 
SC_SRC_CD , 
HOLD_FOR_CALLBK , 
CB_MEMBER , 
CB_REQ_MIN , 
SC_VEH_LIC_ST_CD , 
SC_VEH_LIC_TAG_NR , 
SC_VEH_MANF_YR_DT , 
SC_VEH_MANFR_NM , 
SC_VEH_MDL_NM , 
SC_VEH_COLR_NM , 
BL_NEAR_CTY_NM , 
BL_N_LNDMRK_TX , 
BL_OOT_IN , 
BL_TEL_NR_EXT , 
BL_TYP_CD , 
BL_AREA , 
BL_UPARS_TX , 
BL_STATE_CD , 
SVC_REGN_GRID_ID , 
TOW_DST_UPRS_TX , 
FACIL_INT_ID , 
SC_A_SVC_TRK_ID , 
SC_A_SVC_TRK_D_ID , 
SC_REASGN_RSN_CD , 
PROB1_CD , 
PROB2_CD , 
CSH_COLL , 
STATUS_CHGS , 
EMPLE_ID , 
SC_CNTC_EXP_DT_YR , 
PLUS_IND , 
CHG_ENTITLEMENT , 
BATCH_CD , 
MMP_CD , 
SC_SVC_TIK_NO , 
SC_TOD_IND , 
SC_PROB_IND , 
RATE_CATEGORY , 
CALL_SOURCE , 
CALL_COST , 
MILES_START , 
MILES_ONLC , 
MILES_DEST , 
PAY_ID , 
SUSPENDED , 
RECIPROCALIZED , 
DTL_PROB1_CD , 
DTL_PROB2_CD , 
DTL_STS_RSN_CD , 
SC_VEH_TYPE , 
SPP_TKT , 
SPP_CADJ , 
SC_TRC_FLAG , 
SC_TD_TYPE , 
BL_TIMEZONE , 
BL_ZIP , 
BL_ZIP4 , 
HIGHWAY_CALL , 
MILE_MARKER , 
CALLBOX , 
BL_VERIFIED_LOC , 
AA_VERIFIED_LOC , 
ACCIDENT_ASSIST_FLAG , 
PUBLIC_FLAG , 
TD_VERIFIED_LOC , 
ER_DIRECTIONS , 
TOW_DIRECTIONS , 
SC_VEH_ODOMETER , 
SC_VEH_VIN ,
ETL_JOB_RUN_ID , 
SOURCE_SYSTEM_CD , 
CREATE_DTTIME , 
CREATE_BY , 
LAST_UPDATE_DTTIME , 
LAST_UPDATE_BY )
VALUES
(
SRC.COMM_CTR_ID , 
CAST (SRC.SC_DT AS DATETIME) , 
CAST(SRC.SC_ID AS INT64) , 
CAST( SRC.ARCH_DATE AS DATETIME) , 
SRC.SC_CALL_CLB_CD , 
SRC.SC_CALL_MBR_ID , 
SRC.SC_CALL_ASC_ID , 
SRC.SC_CSH_RQR_IN , 
SRC.SC_CNTC_FST_NM , 
SRC.SC_CNTC_LST_NM , 
SRC.SC_CNTC_SUFFIX , 
SRC.SC_PRTY_CD , 
CAST (SRC.SC_WAIT_TM AS INT64) , 
CAST(SRC.SC_PRMS_ARR_TM AS DATETIME) , 
SRC.SC_RED_FLAG_IN , 
SRC.STATUS_CD , 
SRC.SC_STS_RSN_CD , 
SRC.CB_FLAG , 
CAST(SRC.SC_RCVD_TM AS DATETIME), 
SRC.HIST_FLAG , 
SRC.SC_POLICY , 
SRC.SC_SRC_CD , 
SRC.HOLD_FOR_CALLBK , 
SRC.CB_MEMBER , 
CAST (SRC.CB_REQ_MIN AS INT64) , 
SRC.SC_VEH_LIC_ST_CD , 
SRC.SC_VEH_LIC_TAG_NR , 
SRC.SC_VEH_MANF_YR_DT , 
SRC.SC_VEH_MANFR_NM , 
SRC.SC_VEH_MDL_NM , 
SRC.SC_VEH_COLR_NM , 
SRC.BL_NEAR_CTY_NM , 
SRC.BL_N_LNDMRK_TX , 
SRC.BL_OOT_IN , 
SRC.BL_TEL_NR_EXT , 
SRC.BL_TYP_CD , 
SRC.BL_AREA , 
SRC.BL_UPARS_TX , 
SRC.BL_STATE_CD , 
SRC.SVC_REGN_GRID_ID , 
SRC.TOW_DST_UPRS_TX , 
CAST(SRC.FACIL_INT_ID AS INT64) , 
SRC.SC_A_SVC_TRK_ID , 
SRC.SC_A_SVC_TRK_D_ID , 
SRC.SC_REASGN_RSN_CD , 
SRC.PROB1_CD , 
SRC.PROB2_CD , 
CAST(SRC.CSH_COLL AS FLOAT64) , 
SRC.STATUS_CHGS , 
SRC.EMPLE_ID , 
CAST (SRC.SC_CNTC_EXP_DT_YR AS DATETIME) , 
SRC.PLUS_IND , 
SRC.CHG_ENTITLEMENT , 
SRC.BATCH_CD , 
SRC.MMP_CD , 
SRC.SC_SVC_TIK_NO , 
SRC.SC_TOD_IND , 
SRC.SC_PROB_IND , 
SRC.RATE_CATEGORY , 
SRC.CALL_SOURCE , 
CAST(SRC.CALL_COST AS FLOAT64), 
CAST(SRC.MILES_START AS FLOAT64) , 
CAST(SRC.MILES_ONLC AS FLOAT64) , 
CAST (SRC.MILES_DEST AS FLOAT64) , 
CAST (SRC.PAY_ID AS INT64) , 
CAST(SRC.SUSPENDED AS STRING) , 
SRC.RECIPROCALIZED , 
SRC.DTL_PROB1_CD , 
SRC.DTL_PROB2_CD , 
SRC.DTL_STS_RSN_CD , 
SRC.SC_VEH_TYPE , 
SRC.SPP_TKT , 
SRC.SPP_CADJ , 
SRC.SC_TRC_FLAG , 
SRC.SC_TD_TYPE , 
SRC.BL_TIMEZONE , 
CAST (SRC.BL_ZIP AS INT64) , 
CAST (SRC.BL_ZIP4 AS INT64) , 
SRC.HIGHWAY_CALL , 
CAST (SRC.MILE_MARKER AS INT64) , 
SRC.CALLBOX , 
SRC.BL_VERIFIED_LOC , 
SRC.AA_VERIFIED_LOC , 
SRC.ACCIDENT_ASSIST_FLAG , 
SRC.PUBLIC_FLAG , 
SRC.TD_VERIFIED_LOC , 
SRC.ER_DIRECTIONS , 
SRC.TOW_DIRECTIONS , 
CAST (SRC.SC_VEH_ODOMETER AS FLOAT64) , 
SRC.SC_VEH_VIN , 
CAST (SRC.JOB_RUN_ID AS INT64) , 
SRC.SOURCE_SYSTEM_CD , 
current_datetime() ,
SRC.CREATED_BY , 
current_datetime() ,
"Last Updated by"
)
