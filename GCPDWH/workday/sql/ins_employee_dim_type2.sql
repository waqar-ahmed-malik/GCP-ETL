-- For Tye 2 History Based on MD5 Value Change for existing employee
INSERT INTO LANDING.EMPLOYEE_DIM_STAGE  (
EMPLOYEE_ID,
ENT_ID,
LEGAL_FIRST_NM,
LEGAL_MIDDLE_NM,
LEGAL_LAST_NM,
LEGAL_SUFFIX,
HIRE_DT,
TERMINATION_DT,
EMPLOYEE_STATUS,
WORKER_TYPE,
LOCATION_ID,
EMAIL_ADDRESS,
SECONDARY_EMAIL_ADDRESS,
PHONE_NUM,
PHONE_EXTENSION,
LIFE_ID,
PAS_ID,
INSURANCE_REP_ID,
TRAVEL_ID,
COMPANY,
CHANGE_EFFECTIVE_DT,
LANGUAGE_TYPE_CD,
PRFS_DESIG_EFFECTIVE_DT,
PRFS_DESIG_EXPIRATION_DT,
PRFS_DESIG_TYPE_CD,
COST_CENTER_CD,
RESIDENT_LICENSE_IND,
LICENSE_NUM,
LICENSE_STATE,
LICENSE_EFFECTIVE_DT,
LICENSE_EXPIRATION_DT,
LICENSE_TYPE_CD,
JOB_CD,
JOB_CD_DESC,
JOB_CD_EFFECTIVE_DT,
SUPERVISOR_EMPLOYEE_ID,
ORGANIZATION_CD,
WORKER_AVAYA_ID,
SUPERVISOR_HIERARCHY_LEVEL,
SAM_ROLE_ID,
SAM_ROLE_DESC,
SAM_LOGIN_STATUS,
SALES_AGENT_KEY,
SALES_AGENT_STATUS,
WD_ID,
EFFECTIVE_START_DT,
EFFECTIVE_END_DT,
ACTIVE_FLG,
ETL_JOB_RUN_ID,
SOURCE_SYSTEM_CD,
CREATE_DTTIME,
CREATED_BY,
MD5_VALUE,
FILE_ID )
SELECT WRK.EMPLOYEE_ID,
WRK.ENT_ID,
WRK.LEGAL_FIRST_NM,
WRK.LEGAL_MIDDLE_NM,
WRK.LEGAL_LAST_NM,
WRK.LEGAL_SUFFIX,
WRK.HIRE_DT,
WRK.TERMINATION_DT,
WRK.EMPLOYEE_STATUS,
WRK.WORKER_TYPE,
WRK.LOCATION_ID,
WRK.EMAIL_ADDRESS,
WRK.SECONDARY_EMAIL_ADDRESS,
WRK.PHONE_NUM,
WRK.PHONE_EXTENSION,
WRK.LIFE_ID,
WRK.PAS_ID,
WRK.INSURANCE_REP_ID,
WRK.TRAVEL_ID,
SAFE_CAST(WRK.COMPANY AS STRING) AS COMPANY,
WRK.CHANGE_EFFECTIVE_DT,
WRK.LANGUAGE_TYPE_CD,
WRK.PRFS_DESIG_EFFECTIVE_DT,
WRK.PRFS_DESIG_EXPIRATION_DT,
WRK.PRFS_DESIG_TYPE_CD,
SAFE_CAST(WRK.COST_CENTER_CD AS STRING) AS COST_CENTER_CD,
WRK.RESIDENT_LICENSE_IND,
WRK.LICENSE_NUM,
WRK.LICENSE_STATE,
WRK.LICENSE_EFFECTIVE_DT,
WRK.LICENSE_EXPIRATION_DT,
WRK.LICENSE_TYPE_CD,
WRK.JOB_CD,
WRK.JOB_CD_DESC,
WRK.JOB_CD_EFFECTIVE_DT,
WRK.SUPERVISOR_ID,
WRK.ORGANIZATION_CD,
WRK.WORKER_AVAYA_ID,
WRK.SUPERVISOR_HIERARCHY_LEVEL,
WRK.SAM_ROLE_ID,
SAFE_CAST(WRK.SAM_ROLE_DESC AS STRING) AS SAM_ROLE_DESC,
SAFE_CAST(WRK.SAM_LOGIN_STATUS AS STRING) AS SAM_LOGIN_STATUS,
WRK.SALES_AGENT_KEY,
WRK.SALES_AGENT_STATUS,
WRK.WD_ID,
PARSE_DATE('%Y%m%d',WRK.FILE_ID ) AS EFFECTIVE_START_DT,
SAFE_CAST('9999-12-31' AS DATE) AS EFFECTIVE_END_DT,
'Y' AS ACTIVE_FLG,
'V_JOB_RUN_ID' AS ETL_JOB_RUN_ID,
'WORKDAY' AS SOURCE_SYSTEM_CD,
CURRENT_DATE() AS CREATE_DTTIME,
'V_JOB_NAME' AS CREATED_BY,
WRK.MD5_VALUE,
WRK.FILE_ID
FROM LANDING.WORK_WD_EMPLOYEE WRK
WHERE
WRK.EMPLOYEE_ID NOT IN
    (SELECT EMPLOYEE_ID FROM LANDING.EMPLOYEE_DIM_STAGE WHERE ACTIVE_FLG='Y') --For new Employees
OR
WRK.EMPLOYEE_ID IN
    (SELECT EMPLOYEE_ID FROM LANDING.EMPLOYEE_DIM_STAGE EMP
    WHERE EMP.ACTIVE_FLG='Y' AND WRK.MD5_VALUE <> EMP.MD5_VALUE AND EMP.TERMINATION_DT IS NULL)