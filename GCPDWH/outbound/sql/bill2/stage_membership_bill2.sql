MERGE INTO LANDING.STAGE_MEMBERSHIP_BILL  TGT 
USING (SELECT ROW_NUMBER() OVER() as MEMBERSHIP_BILL_ID, BILL1.* from 
(select MEMBERSHIP_BILL_ID as UNIQUE_KEY,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN MEMBER_NUM ELSE NULL END) AS MEMBER_NUM,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN MEMBER_SINCE ELSE NULL END) AS MEMBER_SINCE,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN MBRS_EXPIR_DT ELSE NULL END) AS MEMBER_EXPIRY_DT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN MEMBERSHIP_LEVEL_DESC ELSE NULL END) AS PLAN,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN EVENT_TYPE ELSE NULL END) AS EVENT_TYPE,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN FIRST_NAME ELSE NULL END) AS FIRST_NAME,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN MIDDLE_INITIAL ELSE NULL END) AS MI,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN LAST_NAME ELSE NULL END) AS LAST_NAME,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN PRM_EMAIL_ADDRESS ELSE NULL END) AS EMAIL,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN PRM_HOME_PHONE_NUM ELSE NULL END) AS PHONE,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN BILLING_ADDRESS_LINE1 ELSE NULL END) AS ADDRESS1,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN BILLING_CITY ELSE NULL END) AS CITY,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN BILLING_STATE ELSE NULL END) AS STATE,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN BILLING_ZIP ELSE NULL END) AS ZIP,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN COUNTRY ELSE NULL END) AS COUNTRY,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN CC_LAST_4_DIGITS ELSE NULL END)  AS CC_LAST_4_DIGITS,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN PAY_FAILED ELSE NULL END) AS PAY_FAILED,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN PROMOCODE1 ELSE NULL END) AS PROMOCODE1,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN PROMO1_AMOUNT ELSE NULL END) AS PROMO1_AMOUNT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN PROMOCODE2 ELSE NULL END) AS PROMOCODE2,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN PROMO2_AMOUNT ELSE NULL END) AS PROMO2_AMOUNT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN PROMOCODE3 ELSE NULL END) AS PROMOCODE3,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN PROMO3_AMOUNT ELSE NULL END) AS PROMO3_AMOUNT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN SEC_MEMBER_DATA_PRESENT ELSE NULL END) AS SEC_MEMBER_DATA_PRESENT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN ASSOC_MEMBER_DATA_PRESENT ELSE NULL END) AS ASSOC_MEMBER_DATA_PRESENT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN NUM_ASSOC_MEMBER ELSE NULL END) AS NUM_ASSOC_MEMBERS,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN DONOR_MEMBER_DATA_PRESENT ELSE NULL END) AS DONOR_MEMBER_DATA_PRESENT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN GROUP_DATA_PRESENT ELSE NULL END) AS GROUP_DATA_PRESENT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN NON_INV_ITEM_PRESENT ELSE NULL END) AS OTHER_INV_ITEM_DATA_PRESENT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN NON_INV_ITEMS ELSE NULL END) AS NUM_OTHER_INV_ITEMS,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN MEMBER_NUM ELSE NULL END) AS PRIMARY_MEMBER_NUM,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN MEMBER_SINCE ELSE NULL END) AS PRIMARY_MEMBER_SINCE,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN MBRS_EXPIR_DT ELSE NULL END) AS PRIMARY_MEMBER_EXPIRY_DT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN FIRST_NAME ELSE NULL END) AS PRIMARY_MEMBER_FIRST_NAME,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN MIDDLE_INITIAL ELSE NULL END) AS PRIMARY_MEMBER_MI,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN LAST_NAME ELSE NULL END) AS PRIMARY_MEMBER_LAST_NAME,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN NAME_ON_MEMBERSHIP_CARD ELSE NULL END) AS PRIMARY_MEMBER_FULL_NAME,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN BILL_DESC ELSE NULL END) AS PRIMARY_MEMBER_LINE_ITEM_DES,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN BILL_AMT ELSE NULL END) AS PRIMARY_MEMBER_LINE_ITEM_AMT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN BILL_AMT ELSE NULL END) AS PRIMARY_MEMBER_ALTERNATE_AMT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=2 THEN MEMBER_NUM ELSE NULL END) AS SECONDARY_MEMBER_NUM,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=2 THEN MEMBER_SINCE ELSE NULL END) AS SECONDARY_MEMBER_SINCE,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=2 THEN MBRS_EXPIR_DT ELSE NULL END) AS SECONDARY_MEMBER_EXPIRY_DT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=2 THEN FIRST_NAME ELSE NULL END) AS SECONDARY_MEMBER_FIRST_NAME,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=2 THEN MIDDLE_INITIAL ELSE NULL END) AS SECONDARY_MEMBER_MI,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=2 THEN LAST_NAME ELSE NULL END) AS SECONDARY_MEMBER_LAST_NAME,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=2 THEN NAME_ON_MEMBERSHIP_CARD ELSE NULL END) AS SECONDARY_MEMBER_FULL_NAME,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=2 THEN BILL_DESC ELSE NULL END) AS SECONDARY_MEMBER_LINE_ITEM_DES,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=2 THEN BILL_AMT ELSE NULL END) AS SECONDARY_MEMBER_LINE_ITEM_AMT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=2 THEN BILL_AMT ELSE NULL END) AS SECONDARY_MEMBER_ALTERNATE_AMT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=3 THEN MEMBER_NUM ELSE NULL END) AS ASSOC_1_MEMBER_NUM,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=3 THEN MEMBER_SINCE ELSE NULL END) AS ASSOC_1_MEMBER_SINCE,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=3 THEN MBRS_EXPIR_DT ELSE NULL END) AS ASSOC_1_MEMBER_EXPIRY_DT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=3 THEN FIRST_NAME ELSE NULL END) AS ASSOC_1_FIRST_NAME,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=3 THEN MIDDLE_INITIAL ELSE NULL END) AS ASSOC_1_MI,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=3 THEN LAST_NAME ELSE NULL END) AS ASSOC_1_LAST_NAME,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=3 THEN NAME_ON_MEMBERSHIP_CARD ELSE NULL END) AS ASSOC_1_FULL_NAME,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=3 THEN BILL_DESC ELSE NULL END) AS ASSOC_1_LINE_ITEM_DES,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=3 THEN BILL_AMT ELSE NULL END) AS ASSOC_1_LINE_ITEM_AMT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=3 THEN BILL_AMT ELSE NULL END) AS ASSOC_1_ALTERNATE_AMT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=4 THEN MEMBER_NUM ELSE NULL END) AS ASSOC_2_MEMBER_NUM,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=4 THEN MEMBER_SINCE ELSE NULL END) AS ASSOC_2_MEMBER_SINCE,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=4 THEN MBRS_EXPIR_DT ELSE NULL END) AS ASSOC_2_MEMBER_EXPIRY_DT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=4 THEN FIRST_NAME ELSE NULL END) AS ASSOC_2_FIRST_NAME,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=4 THEN MIDDLE_INITIAL ELSE NULL END) AS ASSOC_2_MI,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=4 THEN LAST_NAME ELSE NULL END) AS ASSOC_2_LAST_NAME,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=4 THEN NAME_ON_MEMBERSHIP_CARD ELSE NULL END) AS ASSOC_2_FULL_NAME,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=4 THEN BILL_DESC ELSE NULL END) AS ASSOC_2_LINE_ITEM_DES,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=4 THEN BILL_AMT ELSE NULL END) AS ASSOC_2_LINE_ITEM_AMT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=4 THEN BILL_AMT ELSE NULL END) AS ASSOC_2_ALTERNATE_AMT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=5 THEN MEMBER_NUM ELSE NULL END) AS ASSOC_3_MEMBER_NUM,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=5 THEN MEMBER_SINCE ELSE NULL END) AS ASSOC_3_MEMBER_SINCE,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=5 THEN MBRS_EXPIR_DT ELSE NULL END) AS ASSOC_3_MEMBER_EXPIRY_DT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=5 THEN FIRST_NAME ELSE NULL END) AS ASSOC_3_FIRST_NAME,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=5 THEN MIDDLE_INITIAL ELSE NULL END) AS ASSOC_3_MI,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=5 THEN LAST_NAME ELSE NULL END) AS ASSOC_3_LAST_NAME,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=5 THEN NAME_ON_MEMBERSHIP_CARD ELSE NULL END) AS ASSOC_3_FULL_NAME,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=5 THEN BILL_DESC ELSE NULL END) AS ASSOC_3_LINE_ITEM_DES,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=5 THEN BILL_AMT ELSE NULL END) AS ASSOC_3_LINE_ITEM_AMT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=5 THEN BILL_AMT ELSE NULL END) AS ASSOC_3_ALTERNATE_AMT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=6 THEN MEMBER_NUM ELSE NULL END) AS ASSOC_4_MEMBER_NUM,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=6 THEN MEMBER_SINCE ELSE NULL END) AS ASSOC_4_MEMBER_SINCE,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=6 THEN MBRS_EXPIR_DT ELSE NULL END) AS ASSOC_4_MEMBER_EXPIRY_DT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=6 THEN FIRST_NAME ELSE NULL END) AS ASSOC_4_FIRST_NAME,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=6 THEN MIDDLE_INITIAL ELSE NULL END) AS ASSOC_4_MI,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=6 THEN LAST_NAME ELSE NULL END) AS ASSOC_4_LAST_NAME,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=6 THEN NAME_ON_MEMBERSHIP_CARD ELSE NULL END) AS ASSOC_4_FULL_NAME,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=6 THEN BILL_DESC ELSE NULL END) AS ASSOC_4_LINE_ITEM_DES,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=6 THEN BILL_AMT ELSE NULL END) AS ASSOC_4_LINE_ITEM_AMT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=6 THEN BILL_AMT ELSE NULL END) AS ASSOC_4_ALTERNATE_AMT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=7 THEN MEMBER_NUM ELSE NULL END) AS ASSOC_5_MEMBER_NUM,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=7 THEN MEMBER_SINCE ELSE NULL END) AS ASSOC_5_MEMBER_SINCE,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=7 THEN MBRS_EXPIR_DT ELSE NULL END) AS ASSOC_5_MEMBER_EXPIRY_DT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=7 THEN FIRST_NAME ELSE NULL END) AS ASSOC_5_FIRST_NAME,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=7 THEN MIDDLE_INITIAL ELSE NULL END) AS ASSOC_5_MI,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=7 THEN LAST_NAME ELSE NULL END) AS ASSOC_5_LAST_NAME,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=7 THEN NAME_ON_MEMBERSHIP_CARD ELSE NULL END) AS ASSOC_5_FULL_NAME,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=7 THEN BILL_DESC ELSE NULL END) AS ASSOC_5_LINE_ITEM_DES,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=7 THEN BILL_AMT ELSE NULL END) AS ASSOC_5_LINE_ITEM_AMT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=7 THEN BILL_AMT ELSE NULL END) AS ASSOC_5_ALTERNATE_AMT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=8 THEN MEMBER_NUM ELSE NULL END) AS ASSOC_6_MEMBER_NUM,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=8 THEN MEMBER_SINCE ELSE NULL END) AS ASSOC_6_MEMBER_SINCE,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=8 THEN MBRS_EXPIR_DT ELSE NULL END) AS ASSOC_6_MEMBER_EXPIRY_DT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=8 THEN FIRST_NAME ELSE NULL END) AS ASSOC_6_FIRST_NAME,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=8 THEN MIDDLE_INITIAL ELSE NULL END) AS ASSOC_6_MI,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=8 THEN LAST_NAME ELSE NULL END) AS ASSOC_6_LAST_NAME,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=8 THEN NAME_ON_MEMBERSHIP_CARD ELSE NULL END) AS ASSOC_6_FULL_NAME,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=8 THEN BILL_DESC ELSE NULL END) AS ASSOC_6_LINE_ITEM_DES,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=8 THEN BILL_AMT ELSE NULL END) AS ASSOC_6_LINE_ITEM_AMT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=8 THEN BILL_AMT ELSE NULL END) AS ASSOC_6_ALTERNATE_AMT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=9 THEN MEMBER_NUM ELSE NULL END) AS ASSOC_7_MEMBER_NUM,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=9 THEN MEMBER_SINCE ELSE NULL END) AS ASSOC_7_MEMBER_SINCE,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=9 THEN MBRS_EXPIR_DT ELSE NULL END) AS ASSOC_7_MEMBER_EXPIRY_DT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=9 THEN FIRST_NAME ELSE NULL END) AS ASSOC_7_FIRST_NAME,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=9 THEN MIDDLE_INITIAL ELSE NULL END) AS ASSOC_7_MI,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=9 THEN LAST_NAME ELSE NULL END) AS ASSOC_7_LAST_NAME,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=9 THEN NAME_ON_MEMBERSHIP_CARD ELSE NULL END) AS ASSOC_7_FULL_NAME,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=9 THEN BILL_DESC ELSE NULL END) AS ASSOC_7_LINE_ITEM_DES,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=9 THEN BILL_AMT ELSE NULL END) AS ASSOC_7_LINE_ITEM_AMT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=9 THEN BILL_AMT ELSE NULL END) AS ASSOC_7_ALTERNATE_AMT,
MAX(CASE WHEN BILL_PAY_METHOD='1' and MEMBER_SEQUENCE_NUM=1 THEN TOTAL_AMT_DUE ELSE round(TOTAL_AMT_DUE-10,2) END) AS TOTAL_ALTERNATE_AMT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN DONOR_FIRST_NAME ELSE NULL END) AS DONOR_FIRST_NAME,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN DONOR_MI ELSE NULL END) AS DONOR_MI,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN DONOR_LAST_NAME ELSE NULL END) AS DONOR_LAST_NAME,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN GROUP_TYPE ELSE NULL END) AS MEM_GROUP,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN NI_ARIA_BILL_AMT ELSE NULL END) AS ADDITIONAL_DUES_AND_FEES,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN IFNULL(TOTAL_AMT_DUE,0) ELSE 0 END) AS TOTAL_AMT_DUE,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN IFNULL(PAYMENT_RECEIVED,0) ELSE 0 END) AS TOTAL_AMT_PAID,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN PAYMENT_DUE_DATE ELSE null END) AS PAYMENT_DUE_DATE,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN PLUS_UPGRADE_AMT ELSE NULL END) AS PLUS_UPGRADE_AMT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN PREMIER_UPGRADE_AMT ELSE NULL END) AS PREMIER_UPGRADE_AMT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN ASSOCIATE_CHARGE_AMT ELSE NULL END) AS ASSOCIATE_CHARGE_RATE,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN STATEMENT_NO ELSE NULL END) AS STATEMENT_NO,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN 'N' ELSE NULL END) AS FILE_GENERATED,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN MEMBERSHIP_BILL_ID ELSE NULL END) AS BILL_KEY,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN BILL_PAY_METHOD ELSE NULL END) AS BILL_PAY_METHOD_CD,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN CURRENTLY_HAS_AUTO ELSE NULL END) AS CURRENTLY_HAS_AUTO,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN CURRENTLY_HAS_HOME ELSE NULL END) AS CURRENTLY_HAS_HOME,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN NI_BILL_LINE_NO ELSE NULL END) AS  LINE_ITEM,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN NI_BILL_DESC ELSE NULL END) AS  DESCRIPTION,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN NI_ARIA_BILL_AMT ELSE NULL END) AS AMOUNT,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN ISSUING_STATE ELSE NULL END) AS ISSUING_STATE,
MAX(CASE WHEN MEMBER_SEQUENCE_NUM=1 THEN PREFERRED_LANGUAGE ELSE NULL END) AS PREFERRED_LANGUAGE
from LANDING.WORK_STG_MEMBERSHIP_BILL2
group by MEMBERSHIP_BILL_ID) BILL1) SRC
ON (TGT.STATEMENT_NO=SRC.STATEMENT_NO 
AND TGT.BILL_KEY=SRC.BILL_KEY 
AND TGT.SOURCE_SYSTEM_CD='CONNECT SUITE'
AND CAST(TGT.CREATE_DTTIME AS DATE)>=DATE_SUB(current_date(), INTERVAL 7 DAY) 
AND CAST(TGT.CREATE_DTTIME AS DATE)<=current_date()
)
WHEN NOT MATCHED THEN
  INSERT (MEMBERSHIP_BILL_ID,
  ARIA_ACCOUNT_ID,
MEMBER_NUM,
MEMBER_SINCE,
MEMBER_EXPIRY_DT,
PLAN,
EVENT_TYPE,
FIRST_NAME,
MI,
LAST_NAME,
EMAIL,
PHONE,
ADDRESS1,
CITY,
STATE,
ZIP,
COUNTRY,
CC_LAST_4_DIGITS,
PAY_FAILED,
PROMOCODE1,
PROMO1_AMOUNT,
PROMOCODE2,
PROMO2_AMOUNT,
PROMOCODE3,
PROMO3_AMOUNT,
SEC_MEMBER_DATA_PRESENT,
ASSOC_MEMBER_DATA_PRESENT,
NUM_ASSOC_MEMBERS,
DONOR_MEMBER_DATA_PRESENT,
GROUP_DATA_PRESENT,
OTHER_INV_ITEM_DATA_PRESENT,
NUM_OTHER_INV_ITEMS,
PRIMARY_MEMBER_NUM,
PRIMARY_MEMBER_SINCE,
PRIMARY_MEMBER_EXPIRY_DT,
PRIMARY_MEMBER_FIRST_NAME,
PRIMARY_MEMBER_MI,
PRIMARY_MEMBER_LAST_NAME,
PRIMARY_MEMBER_FULL_NAME,
PRIMARY_MEMBER_LINE_ITEM_DES,
PRIMARY_MEMBER_LINE_ITEM_AMT,
PRIMARY_MEMBER_ALTERNATE_AMT,
SECONDARY_MEMBER_NUM,
SECONDARY_MEMBER_SINCE,
SECONDARY_MEMBER_EXPIRY_DT,
SECONDARY_MEMBER_FIRST_NAME,
SECONDARY_MEMBER_MI,
SECONDARY_MEMBER_LAST_NAME,
SECONDARY_MEMBER_FULL_NAME,
SECONDARY_MEMBER_LINE_ITEM_DES,
SECONDARY_MEMBER_LINE_ITEM_AMT,
SECONDARY_MEMBER_ALTERNATE_AMT,
ASSOC_1_MEMBER_NUM,
ASSOC_1_MEMBER_SINCE,
ASSOC_1_MEMBER_EXPIRY_DT,
ASSOC_1_FIRST_NAME,
ASSOC_1_MI,
ASSOC_1_LAST_NAME,
ASSOC_1_FULL_NAME,
ASSOC_1_LINE_ITEM_DES,
ASSOC_1_LINE_ITEM_AMT,
ASSOC_1_ALTERNATE_AMT,
ASSOC_2_MEMBER_NUM,
ASSOC_2_MEMBER_SINCE,
ASSOC_2_MEMBER_EXPIRY_DT,
ASSOC_2_FIRST_NAME,
ASSOC_2_MI,
ASSOC_2_LAST_NAME,
ASSOC_2_FULL_NAME,
ASSOC_2_LINE_ITEM_DES,
ASSOC_2_LINE_ITEM_AMT,
ASSOC_2_ALTERNATE_AMT,
ASSOC_3_MEMBER_NUM,
ASSOC_3_MEMBER_SINCE,
ASSOC_3_MEMBER_EXPIRY_DT,
ASSOC_3_FIRST_NAME,
ASSOC_3_MI,
ASSOC_3_LAST_NAME,
ASSOC_3_FULL_NAME,
ASSOC_3_LINE_ITEM_DES,
ASSOC_3_LINE_ITEM_AMT,
ASSOC_3_ALTERNATE_AMT,
ASSOC_4_MEMBER_NUM,
ASSOC_4_MEMBER_SINCE,
ASSOC_4_MEMBER_EXPIRY_DT,
ASSOC_4_FIRST_NAME,
ASSOC_4_MI,
ASSOC_4_LAST_NAME,
ASSOC_4_FULL_NAME,
ASSOC_4_LINE_ITEM_DES,
ASSOC_4_LINE_ITEM_AMT,
ASSOC_4_ALTERNATE_AMT,
ASSOC_5_MEMBER_NUM,
ASSOC_5_MEMBER_SINCE,
ASSOC_5_MEMBER_EXPIRY_DT,
ASSOC_5_FIRST_NAME,
ASSOC_5_MI,
ASSOC_5_LAST_NAME,
ASSOC_5_FULL_NAME,
ASSOC_5_LINE_ITEM_DES,
ASSOC_5_LINE_ITEM_AMT,
ASSOC_5_ALTERNATE_AMT,
ASSOC_6_MEMBER_NUM,
ASSOC_6_MEMBER_SINCE,
ASSOC_6_MEMBER_EXPIRY_DT,
ASSOC_6_FIRST_NAME,
ASSOC_6_MI,
ASSOC_6_LAST_NAME,
ASSOC_6_FULL_NAME,
ASSOC_6_LINE_ITEM_DES,
ASSOC_6_LINE_ITEM_AMT,
ASSOC_6_ALTERNATE_AMT,
ASSOC_7_MEMBER_NUM,
ASSOC_7_MEMBER_SINCE,
ASSOC_7_MEMBER_EXPIRY_DT,
ASSOC_7_FIRST_NAME,
ASSOC_7_MI,
ASSOC_7_LAST_NAME,
ASSOC_7_FULL_NAME,
ASSOC_7_LINE_ITEM_DES,
ASSOC_7_LINE_ITEM_AMT,
ASSOC_7_ALTERNATE_AMT,
TOTAL_ALTERNATE_AMT,
DONOR_FIRST_NAME,
DONOR_MI,
DONOR_LAST_NAME,
MEM_GROUP,
ADDITIONAL_DUES_AND_FEES,
TOTAL_AMT_DUE,
TOTAL_AMT_PAID,
PAYMENT_DUE_DATE,
PLUS_UPGRADE_AMT,
PREMIER_UPGRADE_AMT,
ASSOCIATE_CHARGE_RATE,
OUTPUT_FILE_NAME,
STATEMENT_NO,
FILE_GENERATED,
JOB_RUN_ID,
SOURCE_SYSTEM_CD,
CREATE_DTTIME,
UPDATE_DTTIME,
BILL_KEY,
BILL_PAY_METHOD_CD,
CURRENTLY_HAS_AUTO,
CURRENTLY_HAS_HOME,
ISSUING_STATE,
PREFERRED_LANGUAGE,
LINE_ITEM,
DESCRIPTION,
AMOUNT,         
EXCEPTION_FLAG,
EXCEPTION_REASON)
VALUES(
SRC.MEMBERSHIP_BILL_ID + (SELECT IFNULL(MAX(MEMBERSHIP_BILL_ID),0) FROM LANDING.STAGE_MEMBERSHIP_BILL) ,
null,
SRC.MEMBER_NUM,
SRC.MEMBER_SINCE,
SRC.MEMBER_EXPIRY_DT,
SRC.PLAN,
SRC.EVENT_TYPE,
SRC.FIRST_NAME,
SRC.MI,
SRC.LAST_NAME,
SRC.EMAIL,
SRC.PHONE,
SRC.ADDRESS1,
SRC.CITY,
SRC.STATE,
SRC.ZIP,
SRC.COUNTRY,
SRC.CC_LAST_4_DIGITS,
SRC.PAY_FAILED,
SRC.PROMOCODE1,
SRC.PROMO1_AMOUNT,
SRC.PROMOCODE2,
SRC.PROMO2_AMOUNT,
SRC.PROMOCODE3,
SRC.PROMO3_AMOUNT,
SRC.SEC_MEMBER_DATA_PRESENT,
SRC.ASSOC_MEMBER_DATA_PRESENT,
SRC.NUM_ASSOC_MEMBERS,
SRC.DONOR_MEMBER_DATA_PRESENT,
SRC.GROUP_DATA_PRESENT,
SRC.OTHER_INV_ITEM_DATA_PRESENT,
CAST(SRC.NUM_OTHER_INV_ITEMS AS INT64),
SRC.PRIMARY_MEMBER_NUM,
SRC.PRIMARY_MEMBER_SINCE,
SRC.PRIMARY_MEMBER_EXPIRY_DT,
SRC.PRIMARY_MEMBER_FIRST_NAME,
SRC.PRIMARY_MEMBER_MI,
SRC.PRIMARY_MEMBER_LAST_NAME,
SRC.PRIMARY_MEMBER_FULL_NAME,
SRC.PRIMARY_MEMBER_LINE_ITEM_DES,
SRC.PRIMARY_MEMBER_LINE_ITEM_AMT,
SRC.PRIMARY_MEMBER_ALTERNATE_AMT,
SRC.SECONDARY_MEMBER_NUM,
SRC.SECONDARY_MEMBER_SINCE,
SRC.SECONDARY_MEMBER_EXPIRY_DT,
SRC.SECONDARY_MEMBER_FIRST_NAME,
SRC.SECONDARY_MEMBER_MI,
SRC.SECONDARY_MEMBER_LAST_NAME,
SRC.SECONDARY_MEMBER_FULL_NAME,
SRC.SECONDARY_MEMBER_LINE_ITEM_DES,
SRC.SECONDARY_MEMBER_LINE_ITEM_AMT,
SRC.SECONDARY_MEMBER_ALTERNATE_AMT,
SRC.ASSOC_1_MEMBER_NUM,
SRC.ASSOC_1_MEMBER_SINCE,
SRC.ASSOC_1_MEMBER_EXPIRY_DT,
SRC.ASSOC_1_FIRST_NAME,
SRC.ASSOC_1_MI,
SRC.ASSOC_1_LAST_NAME,
SRC.ASSOC_1_FULL_NAME,
SRC.ASSOC_1_LINE_ITEM_DES,
SRC.ASSOC_1_LINE_ITEM_AMT,
SRC.ASSOC_1_ALTERNATE_AMT,
SRC.ASSOC_2_MEMBER_NUM,
SRC.ASSOC_2_MEMBER_SINCE,
SRC.ASSOC_2_MEMBER_EXPIRY_DT,
SRC.ASSOC_2_FIRST_NAME,
SRC.ASSOC_2_MI,
SRC.ASSOC_2_LAST_NAME,
SRC.ASSOC_2_FULL_NAME,
SRC.ASSOC_2_LINE_ITEM_DES,
SRC.ASSOC_2_LINE_ITEM_AMT,
SRC.ASSOC_2_ALTERNATE_AMT,
SRC.ASSOC_3_MEMBER_NUM,
SRC.ASSOC_3_MEMBER_SINCE,
SRC.ASSOC_3_MEMBER_EXPIRY_DT,
SRC.ASSOC_3_FIRST_NAME,
SRC.ASSOC_3_MI,
SRC.ASSOC_3_LAST_NAME,
SRC.ASSOC_3_FULL_NAME,
SRC.ASSOC_3_LINE_ITEM_DES,
SRC.ASSOC_3_LINE_ITEM_AMT,
SRC.ASSOC_3_ALTERNATE_AMT,
SRC.ASSOC_4_MEMBER_NUM,
SRC.ASSOC_4_MEMBER_SINCE,
SRC.ASSOC_4_MEMBER_EXPIRY_DT,
SRC.ASSOC_4_FIRST_NAME,
SRC.ASSOC_4_MI,
SRC.ASSOC_4_LAST_NAME,
SRC.ASSOC_4_FULL_NAME,
SRC.ASSOC_4_LINE_ITEM_DES,
SRC.ASSOC_4_LINE_ITEM_AMT,
SRC.ASSOC_4_ALTERNATE_AMT,
SRC.ASSOC_5_MEMBER_NUM,
SRC.ASSOC_5_MEMBER_SINCE,
SRC.ASSOC_5_MEMBER_EXPIRY_DT,
SRC.ASSOC_5_FIRST_NAME,
SRC.ASSOC_5_MI,
SRC.ASSOC_5_LAST_NAME,
SRC.ASSOC_5_FULL_NAME,
SRC.ASSOC_5_LINE_ITEM_DES,
SRC.ASSOC_5_LINE_ITEM_AMT,
SRC.ASSOC_5_ALTERNATE_AMT,
SRC.ASSOC_6_MEMBER_NUM,
SRC.ASSOC_6_MEMBER_SINCE,
SRC.ASSOC_6_MEMBER_EXPIRY_DT,
SRC.ASSOC_6_FIRST_NAME,
SRC.ASSOC_6_MI,
SRC.ASSOC_6_LAST_NAME,
SRC.ASSOC_6_FULL_NAME,
SRC.ASSOC_6_LINE_ITEM_DES,
SRC.ASSOC_6_LINE_ITEM_AMT,
SRC.ASSOC_6_ALTERNATE_AMT,
SRC.ASSOC_7_MEMBER_NUM,
SRC.ASSOC_7_MEMBER_SINCE,
SRC.ASSOC_7_MEMBER_EXPIRY_DT,
SRC.ASSOC_7_FIRST_NAME,
SRC.ASSOC_7_MI,
SRC.ASSOC_7_LAST_NAME,
SRC.ASSOC_7_FULL_NAME,
SRC.ASSOC_7_LINE_ITEM_DES,
SRC.ASSOC_7_LINE_ITEM_AMT,
SRC.ASSOC_7_ALTERNATE_AMT,
SRC.TOTAL_ALTERNATE_AMT,
SRC.DONOR_FIRST_NAME,
SRC.DONOR_MI,
SRC.DONOR_LAST_NAME,
SRC.MEM_GROUP,
SRC.ADDITIONAL_DUES_AND_FEES,
SRC.TOTAL_AMT_DUE,
SRC.TOTAL_AMT_PAID,
SRC.PAYMENT_DUE_DATE,
SRC.PLUS_UPGRADE_AMT,
SRC.PREMIER_UPGRADE_AMT,
SRC.ASSOCIATE_CHARGE_RATE,
'ST{{ execution_date.strftime("%Y%m%d%H%M%S") }}0022BLL.xml',
SRC.STATEMENT_NO,
'N',
CAST(FORMAT_DATE("%Y%m%d",current_date()) AS INT64),
'CONNECT SUITE',
CURRENT_DATETIME(),
CURRENT_DATETIME(),
SRC.BILL_KEY,
SRC.BILL_PAY_METHOD_CD,
SRC.CURRENTLY_HAS_AUTO,
SRC.CURRENTLY_HAS_HOME,
SRC.ISSUING_STATE,
SRC.PREFERRED_LANGUAGE,
CAST(SRC.LINE_ITEM AS STRING),
SRC.DESCRIPTION,
SRC.AMOUNT,
'N',
NULL
)
