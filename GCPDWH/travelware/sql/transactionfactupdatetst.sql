UPDATE CUSTOMERS.TRAVEL_TRANSACTION_FACT A
SET
TRAVELER_EMAIL=B.EMAIL,
TST_TRIP_ID=B.TST_TRIP_ID, 
INVENTORY_SUPPLIER=B.SUPPLIER, 
MEMBERSHIP_NUM=B.MEMBERSHIP_NUMBER,
ASSOCIATE_ID=SUBSTR( B.MEMBERSHIP_NUMBER , 15,1),	
CLUB_CD=SUBSTR( B.MEMBERSHIP_NUMBER , 4,3)	,
INVOICE_NUM=NULL,	
INVOICE_DT=SAFE_CAST(NULL  AS DATE) ,
SALE_TYPE_CD=B.TRAVEL_TYPE,
SALE_TYPE_DESC=B.TRAVEL_TYPE, 
SALE_POSTED_AMOUNT=B.TOTAL_GROSS_SALE_AMOUNT, 
TRAVEL_TYPE_CD=B.TRAVEL_TYPE ,
TRAVEL_TYPE_DESC=B.TRAVEL_TYPE, 
SALE_NUM=B.TST_BOOKING_ID ,
BOOKING_AGENT_ID=B.TST_AGENT_ID, 
TICKETING_AGENT_ID=B.TST_AGENT_ID, 
SELLING_AGENT_ID=B.CLUB_AGENT_ID ,
NCNU_BRANCH_CD=LPAD(ZIP.BRANCH_ID,3,'0'),
DEPARTURE_DT=DATE(B.TRAVEL_START_DATE) ,
RETURN_DT=DATE(B.TRAVEL_END_DATE) ,
BASE_FARE=B.SUBTOTAL_AMOUNT ,
TOTAL_COST=B.TOTAL_GROSS_SALE_AMOUNT, 
ANTICIPATED_COMMISSION_AMOUNT=B.ESTIMATED_COMMISSION_AGENCY, 
ANTICIPATED_SALE_AMOUNT=CAST(NULL AS FLOAT64) ,
DESTINATION_CITY=B.DESTINATION_CITY ,
PASSENGER_COUNT=B.PASSENGER_COUNT,
AIRLINE=CASE WHEN UPPER(B.TRAVEL_TYPE) = 'AIR' THEN VENDOR ELSE NULL  END,
TICKET_NUM=B.PROVIDER_REFERENCE_NUMBER ,
PROVIDER=B.VENDOR,
BOOKING_DT=DATE(B.BOOKING_DATE ),
BOOKING_TYPE=B.TRAVEL_TYPE ,
CHANGE_DT=DATE(B.MODIFIED_DATE),
CANCELLATION_DT=SAFE_CAST (B.CANCELLATION_DATE AS DATE) ,
SALE_POSTING_DT=DATE(B.BOOKING_DATE) ,
STATUS_CD=SAFE_CAST(NULL AS STRING),
STATUS_CD_DESC=B.STATUS ,
PNR_LOCATOR=B.PROVIDER_REFERENCE_NUMBER, 
MDM_CUSTOMER_KEY=MDM.CUSTOMER_MDM_KEY ,
SETTLE_CD=SAFE_CAST(NULL AS STRING) ,
SETTLE_CD_DESC=SAFE_CAST(NULL AS STRING), 
SOJOURN_CD=SAFE_CAST(NULL AS STRING) ,
CUSTOMER_TYPE_CD=SAFE_CAST(NULL AS STRING), 
CUSTOMER_TYPE_DESC=SAFE_CAST(NULL AS STRING), 
COMMISSION_PERCENT=CAST(NULL AS FLOAT64) ,
COMMISSION_AMOUNT=CAST(NULL AS FLOAT64) ,
REVENUE_TYPE_CD=SAFE_CAST(NULL AS STRING), 
REVENUE_TYPE_DESC=SAFE_CAST(NULL AS STRING),  
INVOICE_POSTED_FLAG=SAFE_CAST(NULL AS STRING),  
PROMOTION_CD=SAFE_CAST(NULL AS STRING) ,
AUTO_TRAVEL_FLAG=SAFE_CAST(NULL AS STRING),  
SOURCE_SYSTEM_BRANCH_CD=SAFE_CAST(NULL AS STRING), 
STP=SAFE_CAST(NULL AS STRING)  ,
DESTINATION_REGION=SAFE_CAST(NULL AS STRING), 
ITINERARY=SAFE_CAST(NULL AS STRING)  ,
RECORD_LOAD_DT=CURRENT_DATE()
FROM LANDING.TRAVEL_TST B
LEFT JOIN CUSTOMER_PRODUCT.BRANCH_ZIP_DIM ZIP
ON B.ZIP=ZIP.ZIP_CODE
LEFT JOIN (SELECT DISTINCT CUSTOMER_MDM_KEY, SOURCE_KEY1 FROM  CUSTOMERS.MDM_CUSTOMER_BRIDGE WHERE SOURCE_SYSTEM='TST') MDM
ON MDM.SOURCE_KEY1=B.TST_BOOKING_ID
WHERE 
A.SOURCE_SYSTEM_CD='TST' and A.SOURCE_SYSTEM_ID = B.TST_BOOKING_ID